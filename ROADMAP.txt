================================================================================
                         SERVLINE DEVELOPMENT ROADMAP
================================================================================

Last Updated: Day 69 (February 18, 2026) — Auto-repair execution engine (Sprint 8.4)

================================================================================
PROJECT MISSION
================================================================================

Upload a real restaurant menu -> accurately parsed -> editable draft -> POS-ready export
No manual re-entry. No desktop dependency. No OCR surprises.

Target Buyer: POS companies (Square, Toast, etc.)

================================================================================
COMPLETED PHASES
================================================================================

[x] Phase 1-2: Portal & Data Model (Days 1-14)
    - Core Flask UI
    - Database schema
    - Draft lifecycle
    - Exports & error handling

[x] Phase 3: Semantic Reconstruction (Days 23-25)
    - Rotation preview
    - Category inference
    - Two-column merge
    - Variant detection

[x] Phase 4: Structural OCR System (Days 26-31)
    - Semantic block understanding
    - Multi-line merging
    - Category hierarchy v2
    - Price Integrity Engine v2

[x] Phase 5: AI Text Surgeon (Days 32-36)
    - Non-hallucinating cleanup
    - Ingredient smoothing
    - Price/category protection

[x] Phase 6: Structured Imports (Days 37-41)
    - CSV/XLSX/JSON parsing
    - Column Mapping UI
    - Unified import flow

[x] Phase 7: Vision & OCR Hardening (Days 42-50)
    - Deterministic orientation
    - Rotation sweep (0/90/180/270)
    - Multi-pass OCR fusion (PSM 4/6/11)
    - Outlier penalty scoring (token inflation detection)
    - Height-ratio line grouping
    - Quality-based selection
    - VALIDATED Day 50: 100% clean extraction on 4 real menus

================================================================================
CURRENT PHASE: Phase 8 — Semantic Menu Intelligence
================================================================================

Status: IN PROGRESS (Days 51-70)

Goal: Improve semantic understanding of menu content now that OCR is stable.
      Wire Claude API for high-quality item extraction.

Sprint 8.1 — Core Grammar & Structure (Days 51-55) *** COMPLETE ***
------------------------------------------------------------------
[x] Menu item grammar parser (parse_menu_line, classify_menu_lines)
[x] Phrase-level category keywords (90+ weighted patterns)
[x] Improved long-name split heuristics (semantic break phrases)
[x] OCR garble stripping (dot-leader noise, dual-signal validation)
[x] Pizza-specific grammar (CAPS split, size headers, topping lists)
[x] Multi-menu testing (full restaurant: pizza, calzones, apps, wings, burgers, wraps)
[x] Contextual multi-pass classification (heading/item resolution)
[x] Item component detection (toppings, sauces, preparation, flavors)
[x] Multi-column merge detection (whitespace-gap heuristic)
[x] Pipeline integration (enrich_grammar_on_text_blocks, confidence tiers)
[x] OCR typo normalization (88Q->BBQ, piZzA->PIZZA, bracket noise)
[x] Fallback OCR hardening (100% on degraded Tesseract output)

    Test suite: 691 cases, 100% pass rate
    Real OCR: 100% classification on 4 menu files (766 non-empty lines)

Sprint 8.2 — Variant & Portion Logic (Days 56-60) *** COMPLETE ***
----------------------------------------------------------------------
[x] Shared size vocabulary — single source of truth (size_vocab.py)
[x] Size grid context propagation — header -> item variant mapping
[x] Grammar-to-variant bridge — pipeline + website integration
[x] Grammar-aware block building — ALL-CAPS item rescue
[x] Multi-price capture — all N prices preserved (not just first two)
[x] Website OCR quality — psm 3 + image preprocessing
[x] Variant price validation — S < M < L monotonic check, track-separated
[x] Portion-aware price rules — half < whole, slice < pie
[x] Canonical size ordering — ordinal positions for all size types
[x] Combo modifier detection — "W/FRIES", "WIFRIES" normalization
[x] Combo food vocabulary — ~35 side items, truncation tolerance
[x] Combo kind classification — context-aware variant building
[x] Claude API extraction pipeline — 106 items at 90% confidence
[x] Three-strategy extraction — Claude API -> Heuristic AI -> Legacy JSON
[x] Clean OCR text path — 7,736 chars via image_to_string
[x] Auto-redirect from import view to draft editor
[x] Bug fixes: duplicate OCR removal, draft_path timing, error visibility
[x] Cross-variant consistency checks — duplicate, zero-price, mixed-kind,
    size-gap, grid-completeness, grid-count-outlier (Day 59)
[x] Variant confidence scoring — multi-signal per-variant scoring with
    label clarity, grammar context, grid boost, flag penalties (Day 60)

    Test suite: 1,682 cases, 100% pass rate
    Real import: 115 items from full restaurant menu (was 18 garbled)

    Day 61 test suite: 109 cases, 100% pass rate
    Day 62 test suite: 96 cases, 100% pass rate
    Day 63 test suite: 51 cases, 100% pass rate
    Day 64 test suite: 75 cases, 100% pass rate
    Day 65 test suite: 75 cases, 100% pass rate
    Day 68 test suite: 88 cases, 100% pass rate
    Day 69 test suite: 76 cases, 100% pass rate
    Total: 2,448 tests, all passing

Sprint 8.3 — Cross-Item Consistency (Days 61-65) *** COMPLETE ***
-----------------------------------------------------------------
[x] Cross-item consistency foundation — new module + pipeline Step 9.1 (Day 61)
    - Duplicate/near-duplicate name detection (exact normalized match)
    - Category price outlier detection (MAD-based, 3σ threshold)
    - Category isolation detection (neighbor window ±2)
    - Both code paths wired (pipeline + ai_ocr_helper)
[x] Fuzzy name matching — SequenceMatcher, 0.82 threshold, 4-char min (Day 62)
    - Three-phase: exact → fuzzy on remaining items
    - OCR typos: "BUFALO"→"BUFFALO", "MARGHERITA"→"MARGARITA"
    - Price-aware: same price → info, different → warn
    - Zero new dependencies (difflib is stdlib)
[x] Category reassignment suggestions — 4-signal neighbor smoothing (Day 63)
    - Neighbor agreement (+-3 window), keyword fit, price band, original confidence
    - Keyword guard: 2+ keyword matches for current category suppresses suggestion
    - Minimum 0.30 confidence to emit flag; severity always "info"
    - Reuses CATEGORY_KEYWORDS and CATEGORY_PRICE_BANDS from category_infer.py
[x] Cross-category price coherence — 16 directional rules, median-based (Day 64)
    - Beverages < Sides/Salads/Wings/Subs/Burgers/Pizza/Pasta/Calzones
    - Sides < Subs/Burgers/Pizza/Pasta/Calzones; Desserts < Pizza/Pasta/Calzones
    - 30% minimum gap guard; dedup to 1 flag per item per direction
    - Catches OCR price errors, miscategorization, data entry errors
[x] Cross-item variant pattern enforcement — 3 category-level checks (Day 65)
    - Variant count consistency: MODE-based, gap >= 2 to flag
    - Variant label set consistency: dominant set with subset/superset tolerance
    - Price step consistency: MAD-based outlier detection on avg step per item
    - All three checks severity "info"; no pipeline rewiring needed

Sprint 8.4 — Semantic Confidence (Days 66-70)
----------------------------------------------
[x] Unified semantic confidence scoring — 5 weighted signals, audit trail (Day 66)
    - Grammar/parse confidence (0.30), name quality (0.20), price presence (0.20),
      variant quality (0.15), flag penalty (0.15)
    - Per-item semantic_confidence (0.0-1.0) + semantic_confidence_details audit trail
    - Polymorphic: works with both Path A (ocr_pipeline) and Path B (ai_ocr_helper)
    - Pipeline Step 9.2, after cross-item consistency (Step 9.1)
[x] Confidence tiers + menu-level aggregation (Day 67)
    - Per-item: semantic_tier (high/medium/low/reject) + needs_review flag
    - Menu-level: compute_menu_confidence_summary() returns mean/median/stdev,
      tier distribution, category breakdowns, quality grade (A/B/C/D)
    - Pipeline Step 9.3, after score_semantic_confidence (Step 9.2)
[x] Confidence-driven auto-repair recommendations (Day 68)
    - generate_repair_recommendations(items): per-item actionable repair suggestions
    - 6 recommendation types: garbled_name, name_quality, price_missing,
      category_reassignment, variant_standardization, flag_attention
    - Priority from tier: reject→critical, low→important, medium→suggested
    - Auto-fixable recs with proposed_fix for all-caps, OCR corrections, categories
    - compute_repair_summary(items): menu-level repair statistics
    - Pipeline Step 9.4, after classify_confidence_tiers (Step 9.3)
[x] Auto-repair execution engine (Day 69)
    - apply_auto_repairs(items): executes auto-fixable recommendations
    - Name fixes: all-caps→title, garbled→corrected, OCR→fixed
    - Category fixes: reassignment from cross-item suggestions
    - Per-item audit trail: auto_repairs_applied [{type, field, old_value, new_value}]
    - rec["applied"] = True on executed recs, idempotent on re-run
    - Re-scores after repair (score_semantic_confidence + classify_confidence_tiers)
    - Pipeline Step 9.5, after generate_repair_recommendations (Step 9.4)
[ ] Use OCR block heights for heading detection
[ ] Implement section break detection via gaps
[ ] Promote large-font blocks to category headings

Success Metrics (Day 58 actuals vs targets):
- Category accuracy: 75% -> 90%+ (ACHIEVED: proper categories on 115 items)
- Variant detection: 60% -> 85%+ (ACHIEVED: size grid + combo detection)
- Price validation: 40% -> 80%+ (ACHIEVED: monotonic price checks)
- Heading detection: 0% -> 70%+ (ACHIEVED: multi-pass classification)
- Item extraction: 18 garbled -> 115 proper (Claude API + clean OCR)

================================================================================
FUTURE PHASES (Tentative)
================================================================================

Phase 9 — Structured Variants & Export (Days 71-85)
----------------------------------------------------

  PROBLEM STATEMENT:
  Claude API extracts structured size/variant data (e.g., [{label:"Small",price:10.00},
  {label:"Large",price:20.00}]), but claude_items_to_draft_rows() flattens it into a
  single price_cents integer. The draft_items table has no child structure for variants.
  Variant info is lost between extraction and the editor, making POS export impossible
  without re-parsing ephemeral price_text strings.

  SOLUTION:
  Add a draft_item_variants child table, preserve structured variant data end-to-end
  (extraction -> storage -> editor -> export), and redesign the editor to show
  size/combo sub-rows under each item.

Sprint 9.1 — Structured Variant Storage (Days 71-73)
.....................................................

  Day 71: Database Schema & Migration
  ------------------------------------
  [ ] New draft_item_variants table:
        id          INTEGER PRIMARY KEY AUTOINCREMENT
        item_id     INTEGER NOT NULL (FK -> draft_items.id ON DELETE CASCADE)
        label       TEXT NOT NULL        -- "Small", "Large", "W/Fries"
        price_cents INTEGER NOT NULL DEFAULT 0
        kind        TEXT DEFAULT 'size'  -- size/combo/flavor/style/other
        position    INTEGER DEFAULT 0    -- ordering within parent item
        created_at  TEXT NOT NULL
        updated_at  TEXT NOT NULL
  [ ] Auto-migration in drafts.py (detect table, create if missing)
  [ ] CRUD functions: insert_variants(), update_variant(), delete_variant()
  [ ] Update get_draft_items() to LEFT JOIN and group variants by item
  [ ] Index: idx_variants_item on (item_id)

  Day 72: Extraction Pipeline -> Structured Variants
  ---------------------------------------------------
  [ ] Update claude_items_to_draft_rows() to return variants alongside items
      - Currently flattens sizes[] into pipe-delimited price_text string
      - New: return [{item: {...}, variants: [{label, price_cents, kind}]}]
  [ ] Update _draft_items_from_ai_preview() to preserve variant structure
  [ ] Update upsert_draft_items() to accept + insert child variant rows
  [ ] Update heuristic AI path (Strategy 2) to preserve size data
  [ ] Backfill logic: parse existing "Name (Size)" patterns into variant rows
  [ ] Test: upload menu -> verify variants stored in new table

  Day 73: Migration & Backward Compatibility
  -------------------------------------------
  [ ] Existing drafts with no variants continue to work (0 variant rows = single price)
  [ ] price_cents on parent item = base/lowest price (unchanged)
  [ ] Publish flow: if variants exist, use structured data; else use price_cents
  [ ] Test: old drafts load cleanly, new drafts have variant rows

Sprint 9.2 — Editor Redesign (Days 74-77)
..........................................

  Day 74: Variant Sub-Row UI
  --------------------------
  [ ] Update draft_editor.html table layout:
        Parent row:  Name | Description | Base Price | Category | Position | Actions
        Variant row: (indented) Label | Price | Kind | [Delete]
  [ ] Collapse/expand toggle per item (default: collapsed for items with variants)
  [ ] "Add Variant" button per item (adds blank sub-row)
  [ ] Variant kind dropdown: size / combo / flavor / style / other
  [ ] CSS: indented sub-rows, visual grouping with parent

  Day 75: Editor JavaScript
  -------------------------
  [ ] Render variant sub-rows from loaded data
  [ ] Inline editing: variant label, price (currency formatted), kind
  [ ] Add/delete variant sub-rows dynamically (no page reload)
  [ ] Update sidebar outline to use structured variants (remove regex parsing)
  [ ] Drag-to-reorder variant sub-rows within a parent item

  Day 76: Save/Load with Variants
  --------------------------------
  [ ] Update save payload: items[].variants[] nested array
  [ ] Update /drafts/<id>/save endpoint:
      - Insert new variants (no id)
      - Update existing variants (has id)
      - Delete removed variants (deleted_variant_ids[])
  [ ] Update load to return variants grouped by item_id
  [ ] Test: edit variants -> save -> reload -> verify persistence

  Day 77: Low-Confidence & Bulk Operations
  -----------------------------------------
  [ ] Low-confidence panel shows variant info for flagged items
  [ ] Bulk category change preserves variants
  [ ] Duplicate item copies variants
  [ ] Delete item cascades variant deletion (FK constraint)
  [ ] Filter/search includes variant labels

Sprint 9.3 — Export Formats (Days 78-82)
.........................................

  Day 78: CSV & JSON Export with Variants
  ----------------------------------------
  [ ] JSON export: items[].variants[] nested array
        {name, description, price_cents, category, variants: [{label, price_cents, kind}]}
  [ ] CSV export option A (sub-rows): parent row + indented variant rows
  [ ] CSV export option B (columns): one row per item, size prices as extra columns
        name, description, category, price_small, price_medium, price_large
  [ ] User toggle in export UI to choose format

  Day 79: Excel Export with Variants
  -----------------------------------
  [ ] XLSX: variant sub-rows with indented formatting
  [ ] Column headers: auto-generate from actual size labels found in draft
  [ ] Color coding: parent rows bold, variant rows gray/indented
  [ ] Sheet per category option

  Day 80: POS Export Templates
  ----------------------------
  [ ] Square CSV format: item + modifier groups
  [ ] Toast import format: parent/child structure
  [ ] Generic POS JSON: universal item/variant/modifier schema
  [ ] Export preview: show formatted output before download
  [ ] Validation: warn if items missing prices, categories

  Day 81-82: Export Validation & Testing
  ---------------------------------------
  [ ] End-to-end test: upload menu -> extract -> edit variants -> export
  [ ] Verify export files can be imported by target POS systems
  [ ] Edge cases: items with 0 variants, items with 10+ variants
  [ ] Export metrics: item count, variant count, category breakdown

Sprint 9.4 — API & Integration (Days 83-85)
............................................
[ ] REST API endpoints for programmatic access
    - GET  /api/drafts/<id>/items (with variants)
    - POST /api/drafts/<id>/items (create with variants)
    - PUT  /api/drafts/<id>/items/<item_id> (update with variants)
[ ] Webhook support for menu update notifications
[ ] API key authentication
[ ] Rate limiting per API key
[ ] API documentation page

Phase 10 — Multi-Menu & Versioning (Days 86-95)
------------------------------------------------
[ ] Multiple menu support per restaurant
[ ] Menu versioning and history
[ ] Diff view between versions
[ ] Seasonal menu management
[ ] Menu scheduling (breakfast/lunch/dinner)

Phase 11 — Advanced AI Features (Days 96-105)
----------------------------------------------
[ ] Allergen detection and tagging
[ ] Nutritional estimation
[ ] Menu item similarity detection
[ ] Smart category suggestions
[ ] Description generation assistance

Phase 12 — Production Hardening (Days 106-115)
-----------------------------------------------
[ ] Performance optimization
[ ] Caching layer
[ ] Rate limiting
[ ] Error recovery and retry logic
[ ] Monitoring and alerting
[ ] Load testing

Phase 13 — User Experience Polish (Days 116-125)
-------------------------------------------------
[ ] Drag-and-drop menu reordering
[ ] Inline editing improvements
[ ] Keyboard shortcuts
[ ] Mobile-responsive editor
[ ] Undo/redo functionality

================================================================================
LONG-TERM VISION
================================================================================

Year 1 Goals:
- 95%+ accuracy on standard pizza/Italian menus
- Support for 5+ POS export formats
- < 2 minute processing time for typical menu
- Zero manual intervention for clean menus

Year 2 Goals:
- Expand to all restaurant types (Asian, Mexican, American, etc.)
- Real-time menu sync with POS systems
- Multi-language menu support
- White-label solution for POS vendors

================================================================================
KEY PRINCIPLES
================================================================================

1. ONE BRAIN ARCHITECTURE
   - All OCR/AI logic in /storage
   - No duplicate pipelines
   - Single source of truth

2. DETERMINISTIC PROCESSING
   - Same input = same output
   - Full debug artifacts
   - Auditable decisions

3. SAFE AI
   - Never hallucinate prices
   - Never invent categories
   - Preserve original when uncertain

4. INCREMENTAL PROGRESS
   - Daily commits with verified progress
   - Each phase builds on previous
   - No skipping validation

================================================================================
DAILY LOG REFERENCE
================================================================================

Day 69: Auto-repair execution engine — applies fixes, audit trail, re-scoring (76 tests)
Day 68: Confidence-driven auto-repair recommendations — 6 types, priority system (88 tests)
Day 67: Confidence tiers + menu-level aggregation (103 tests)
Day 66: Unified semantic confidence scoring — 5 weighted signals (93 tests)
Day 65: Cross-item variant pattern enforcement — 3 category-level checks (75 tests)
Day 64: Cross-category price coherence — 16 directional rules, median-based (75 tests)
Day 63: Category reassignment suggestions — 4-signal neighbor smoothing (51 tests)
Day 62: Fuzzy name matching — SequenceMatcher near-duplicate detection (96 tests)
Day 61: Cross-item consistency foundation — 3 checks, new module (109 tests)
Day 60: Variant confidence scoring + Sprint 8.2 complete (106 tests)
Day 59: Cross-variant consistency checks (6 validators, 113 tests)
Day 58: Combo modifiers + Claude API extraction pipeline (115 items!)
Day 57: Variant price validation (S < M < L)
Day 56: Size grid context + grammar-to-variant bridge
Day 55: Sprint 8.1 finale — pipeline integration, confidence tiers
Day 54: Item component detection + multi-column merge
Day 53: Multi-menu grammar testing + edge case hardening
Day 52: Pizza grammar rules + real OCR testing (100%)
Day 51: Grammar parser + category keywords + variant vocabulary
Day 50: Validation & Phase 8 Planning
Day 49: Height-ratio line grouping fix
Day 48: Deterministic OCR scoring
Day 47: Multi-pass OCR improvements
Day 46: Rotation sweep wiring
Day 45: Orientation enforcement
Day 44: Maintenance & diagnosis
Day 43: OCR path audit
Day 42: Debug stabilization
Days 37-41: Phase 6 (Structured Imports)
Days 32-36: Phase 5 (AI Text Surgeon)
Days 26-31: Phase 4 (Structural OCR)
Days 23-25: Phase 3 (Semantic Reconstruction)
Days 20-22: Phase A (AI Cleanup)
Days 16-19: OCR Infrastructure
Days 1-14: Portal & Data Model

================================================================================
KEY FILES
================================================================================

Portal:
- portal/app.py              — Flask web portal (~5400 LOC)
- portal/templates/           — Jinja2 templates (import, draft editor, etc.)

One Brain (storage/):
- ocr_facade.py              — Canonical entrypoint for OCR + AI structuring
- ocr_pipeline.py            — Main OCR extraction (~2500 LOC)
- ocr_utils.py               — OCR preprocessing (~1100 LOC)
- ai_ocr_helper.py           — Website /ai/preview endpoint logic
- ai_cleanup.py              — Text normalization (751 LOC)
- ai_menu_extract.py         — Claude API extraction module (~260 LOC)
- category_infer.py          — Category inference (507 LOC)
- cross_item.py              — Cross-item consistency (8 checks, ~830 LOC)
- semantic_confidence.py     — Semantic confidence + tiers + repair recs + auto-repair (~930 LOC)
- variant_engine.py          — Variant normalization + price validation (~720 LOC)
- price_integrity.py         — Price validation (414 LOC)
- category_hierarchy.py      — Hierarchy building (493 LOC)
- parsers/menu_grammar.py    — Grammar parser (~1265 LOC)
- parsers/size_vocab.py      — Shared size vocabulary (~170 LOC)
- parsers/combo_vocab.py     — Combo food vocabulary (~80 LOC)

Tests:
- tests/test_phase8_baseline.py         — 92 cases (Day 51)
- tests/test_day52_pizza_grammar.py     — 66 cases (Day 52)
- tests/test_day53_multi_menu.py        — 86 cases (Day 53)
- tests/test_day54_components.py        — 105 cases (Day 54)
- tests/test_day55_integration.py       — 342 cases (Day 55)
- tests/test_day56_variants.py          — 237 cases (Day 56)
- tests/test_day57_price_validation.py  — 242 cases (Day 57)
- tests/test_day58_combo_modifiers.py   — 275 cases (Day 58)
- tests/test_day59_variant_consistency.py — 113 cases (Day 59)
- tests/test_day60_variant_confidence.py — 106 cases (Day 60)
- tests/test_day61_cross_item.py        — 109 cases (Day 61)
- tests/test_day62_fuzzy_names.py       — 96 cases (Day 62)
- tests/test_day63_category_suggestions.py — 51 cases (Day 63)
- tests/test_day64_cross_category_coherence.py — 75 cases (Day 64)
- tests/test_day65_variant_patterns.py  — 75 cases (Day 65)
- tests/test_day66_semantic_confidence.py — 93 cases (Day 66)
- tests/test_day67_confidence_tiers.py — 103 cases (Day 67)
- tests/test_day68_repair_recommendations.py — 88 cases (Day 68)
- tests/test_day69_auto_repair.py       — 76 cases (Day 69)
- tests/test_rotation_scoring.py        — 18 cases
- TOTAL: 2,448 tests, all passing

================================================================================
