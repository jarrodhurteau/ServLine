================================================================================
                         SERVLINE DEVELOPMENT ROADMAP
================================================================================

Last Updated: Day 58 (February 13, 2026)

================================================================================
PROJECT MISSION
================================================================================

Upload a real restaurant menu -> accurately parsed -> editable draft -> POS-ready export
No manual re-entry. No desktop dependency. No OCR surprises.

Target Buyer: POS companies (Square, Toast, etc.)

================================================================================
COMPLETED PHASES
================================================================================

[x] Phase 1-2: Portal & Data Model (Days 1-14)
    - Core Flask UI
    - Database schema
    - Draft lifecycle
    - Exports & error handling

[x] Phase 3: Semantic Reconstruction (Days 23-25)
    - Rotation preview
    - Category inference
    - Two-column merge
    - Variant detection

[x] Phase 4: Structural OCR System (Days 26-31)
    - Semantic block understanding
    - Multi-line merging
    - Category hierarchy v2
    - Price Integrity Engine v2

[x] Phase 5: AI Text Surgeon (Days 32-36)
    - Non-hallucinating cleanup
    - Ingredient smoothing
    - Price/category protection

[x] Phase 6: Structured Imports (Days 37-41)
    - CSV/XLSX/JSON parsing
    - Column Mapping UI
    - Unified import flow

[x] Phase 7: Vision & OCR Hardening (Days 42-50)
    - Deterministic orientation
    - Rotation sweep (0/90/180/270)
    - Multi-pass OCR fusion (PSM 4/6/11)
    - Outlier penalty scoring (token inflation detection)
    - Height-ratio line grouping
    - Quality-based selection
    - VALIDATED Day 50: 100% clean extraction on 4 real menus

================================================================================
CURRENT PHASE: Phase 8 — Semantic Menu Intelligence
================================================================================

Status: IN PROGRESS (Days 51-70)

Goal: Improve semantic understanding of menu content now that OCR is stable.
      Wire Claude API for high-quality item extraction.

Sprint 8.1 — Core Grammar & Structure (Days 51-55) *** COMPLETE ***
------------------------------------------------------------------
[x] Menu item grammar parser (parse_menu_line, classify_menu_lines)
[x] Phrase-level category keywords (90+ weighted patterns)
[x] Improved long-name split heuristics (semantic break phrases)
[x] OCR garble stripping (dot-leader noise, dual-signal validation)
[x] Pizza-specific grammar (CAPS split, size headers, topping lists)
[x] Multi-menu testing (full restaurant: pizza, calzones, apps, wings, burgers, wraps)
[x] Contextual multi-pass classification (heading/item resolution)
[x] Item component detection (toppings, sauces, preparation, flavors)
[x] Multi-column merge detection (whitespace-gap heuristic)
[x] Pipeline integration (enrich_grammar_on_text_blocks, confidence tiers)
[x] OCR typo normalization (88Q->BBQ, piZzA->PIZZA, bracket noise)
[x] Fallback OCR hardening (100% on degraded Tesseract output)

    Test suite: 691 cases, 100% pass rate
    Real OCR: 100% classification on 4 menu files (766 non-empty lines)

Sprint 8.2 — Variant & Portion Logic (Days 56-60) *** IN PROGRESS ***
----------------------------------------------------------------------
[x] Shared size vocabulary — single source of truth (size_vocab.py)
[x] Size grid context propagation — header -> item variant mapping
[x] Grammar-to-variant bridge — pipeline + website integration
[x] Grammar-aware block building — ALL-CAPS item rescue
[x] Multi-price capture — all N prices preserved (not just first two)
[x] Website OCR quality — psm 3 + image preprocessing
[x] Variant price validation — S < M < L monotonic check, track-separated
[x] Portion-aware price rules — half < whole, slice < pie
[x] Canonical size ordering — ordinal positions for all size types
[x] Combo modifier detection — "W/FRIES", "WIFRIES" normalization
[x] Combo food vocabulary — ~35 side items, truncation tolerance
[x] Combo kind classification — context-aware variant building
[x] Claude API extraction pipeline — 106 items at 90% confidence
[x] Three-strategy extraction — Claude API -> Heuristic AI -> Legacy JSON
[x] Clean OCR text path — 7,736 chars via image_to_string
[x] Auto-redirect from import view to draft editor
[x] Bug fixes: duplicate OCR removal, draft_path timing, error visibility
[ ] Cross-variant consistency checks (Day 59-60)

    Test suite: 1,463 cases, 100% pass rate
    Real import: 115 items from full restaurant menu (was 18 garbled)

Sprint 8.3 — Cross-Item Consistency (Days 61-65)
-------------------------------------------------
[ ] Validate similar items have similar prices
[ ] Detect category outliers (cheap pizza, expensive soda)
[ ] Flag suspicious duplicates with different prices
[ ] Ensure similar items share categories
[ ] Improve neighbor-based category smoothing

Sprint 8.4 — Semantic Confidence (Days 66-70)
----------------------------------------------
[ ] Use OCR block heights for heading detection
[ ] Implement section break detection via gaps
[ ] Promote large-font blocks to category headings
[ ] Multi-signal confidence scoring
[ ] Confidence-based auto-review flagging

Success Metrics (Day 58 actuals vs targets):
- Category accuracy: 75% -> 90%+ (ACHIEVED: proper categories on 115 items)
- Variant detection: 60% -> 85%+ (ACHIEVED: size grid + combo detection)
- Price validation: 40% -> 80%+ (ACHIEVED: monotonic price checks)
- Heading detection: 0% -> 70%+ (ACHIEVED: multi-pass classification)
- Item extraction: 18 garbled -> 115 proper (Claude API + clean OCR)

================================================================================
FUTURE PHASES (Tentative)
================================================================================

Phase 9 — Export & Integration (Days 71-80)
-------------------------------------------
[ ] POS-specific export formats (Square, Toast, Clover)
[ ] API endpoints for third-party integration
[ ] Webhook support for menu updates
[ ] Bulk export capabilities
[ ] Export validation and preview

Phase 10 — Multi-Menu & Versioning (Days 81-90)
------------------------------------------------
[ ] Multiple menu support per restaurant
[ ] Menu versioning and history
[ ] Diff view between versions
[ ] Seasonal menu management
[ ] Menu scheduling (breakfast/lunch/dinner)

Phase 11 — Advanced AI Features (Days 91-100)
----------------------------------------------
[ ] Allergen detection and tagging
[ ] Nutritional estimation
[ ] Menu item similarity detection
[ ] Smart category suggestions
[ ] Description generation assistance

Phase 12 — Production Hardening (Days 101-110)
-----------------------------------------------
[ ] Performance optimization
[ ] Caching layer
[ ] Rate limiting
[ ] Error recovery and retry logic
[ ] Monitoring and alerting
[ ] Load testing

Phase 13 — User Experience Polish (Days 111-120)
-------------------------------------------------
[ ] Drag-and-drop menu reordering
[ ] Inline editing improvements
[ ] Keyboard shortcuts
[ ] Mobile-responsive editor
[ ] Undo/redo functionality

================================================================================
LONG-TERM VISION
================================================================================

Year 1 Goals:
- 95%+ accuracy on standard pizza/Italian menus
- Support for 5+ POS export formats
- < 2 minute processing time for typical menu
- Zero manual intervention for clean menus

Year 2 Goals:
- Expand to all restaurant types (Asian, Mexican, American, etc.)
- Real-time menu sync with POS systems
- Multi-language menu support
- White-label solution for POS vendors

================================================================================
KEY PRINCIPLES
================================================================================

1. ONE BRAIN ARCHITECTURE
   - All OCR/AI logic in /storage
   - No duplicate pipelines
   - Single source of truth

2. DETERMINISTIC PROCESSING
   - Same input = same output
   - Full debug artifacts
   - Auditable decisions

3. SAFE AI
   - Never hallucinate prices
   - Never invent categories
   - Preserve original when uncertain

4. INCREMENTAL PROGRESS
   - Daily commits with verified progress
   - Each phase builds on previous
   - No skipping validation

================================================================================
DAILY LOG REFERENCE
================================================================================

Day 58: Combo modifiers + Claude API extraction pipeline (115 items!)
Day 57: Variant price validation (S < M < L)
Day 56: Size grid context + grammar-to-variant bridge
Day 55: Sprint 8.1 finale — pipeline integration, confidence tiers
Day 54: Item component detection + multi-column merge
Day 53: Multi-menu grammar testing + edge case hardening
Day 52: Pizza grammar rules + real OCR testing (100%)
Day 51: Grammar parser + category keywords + variant vocabulary
Day 50: Validation & Phase 8 Planning
Day 49: Height-ratio line grouping fix
Day 48: Deterministic OCR scoring
Day 47: Multi-pass OCR improvements
Day 46: Rotation sweep wiring
Day 45: Orientation enforcement
Day 44: Maintenance & diagnosis
Day 43: OCR path audit
Day 42: Debug stabilization
Days 37-41: Phase 6 (Structured Imports)
Days 32-36: Phase 5 (AI Text Surgeon)
Days 26-31: Phase 4 (Structural OCR)
Days 23-25: Phase 3 (Semantic Reconstruction)
Days 20-22: Phase A (AI Cleanup)
Days 16-19: OCR Infrastructure
Days 1-14: Portal & Data Model

================================================================================
KEY FILES
================================================================================

Portal:
- portal/app.py              — Flask web portal (~5400 LOC)
- portal/templates/           — Jinja2 templates (import, draft editor, etc.)

One Brain (storage/):
- ocr_facade.py              — Canonical entrypoint for OCR + AI structuring
- ocr_pipeline.py            — Main OCR extraction (~2500 LOC)
- ocr_utils.py               — OCR preprocessing (~1100 LOC)
- ai_ocr_helper.py           — Website /ai/preview endpoint logic
- ai_cleanup.py              — Text normalization (751 LOC)
- ai_menu_extract.py         — Claude API extraction module (~260 LOC)
- category_infer.py          — Category inference (507 LOC)
- variant_engine.py          — Variant normalization + price validation (~720 LOC)
- price_integrity.py         — Price validation (414 LOC)
- category_hierarchy.py      — Hierarchy building (493 LOC)
- parsers/menu_grammar.py    — Grammar parser (~1265 LOC)
- parsers/size_vocab.py      — Shared size vocabulary (~170 LOC)
- parsers/combo_vocab.py     — Combo food vocabulary (~80 LOC)

Tests:
- tests/test_phase8_baseline.py         — 92 cases (Day 51)
- tests/test_day52_pizza_grammar.py     — 66 cases (Day 52)
- tests/test_day53_multi_menu.py        — 86 cases (Day 53)
- tests/test_day54_components.py        — 105 cases (Day 54)
- tests/test_day55_integration.py       — 342 cases (Day 55)
- tests/test_day56_variants.py          — 237 cases (Day 56)
- tests/test_day57_price_validation.py  — 242 cases (Day 57)
- tests/test_day58_combo_modifiers.py   — 275 cases (Day 58)
- tests/test_rotation_scoring.py        — 18 cases
- TOTAL: 1,463 tests, all passing

================================================================================
