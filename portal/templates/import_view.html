{% extends "base.html" %}
{% block title %}Import #{{ job.id }} · ServLine{% endblock %}

{% block content %}
  <style>
    /* Status pills */
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
    .pill-gray  { background:#e5e7eb; color:#374151; }
    .pill-blue  { background:#dbeafe; color:#1e40af; }
    .pill-yellow{ background:#fef3c7; color:#92400e; }
    .pill-green { background:#dcfce7; color:#065f46; }
    .pill-red   { background:#fee2e2; color:#991b1b; }
    .pill-purple{ background:#ede9fe; color:#5b21b6; }

    .actions { display:flex; flex-direction:column; gap:.5rem; }
    .preview { border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0b1220; }
    .preview img { display:block; width:100%; height:auto; }

    /* Disabled look for export buttons until draft_id is resolved */
    .btn[aria-disabled="true"] { opacity:.6; pointer-events:none; }
  </style>

  <section class="card">
    <h1 class="text-xl font-semibold mb-4">Import #{{ job.id }}</h1>

    {% set st = (job.status or '')|lower %}
    {% set pill_class =
      'pill-gray'   if st in ['', 'pending', 'deleted'] else
      'pill-blue'   if st in ['processing', 'restored'] else
      'pill-green'  if st in ['done', 'published', 'approved'] else
      'pill-yellow' if st in ['submitted', 'review'] else
      'pill-purple' if st in ['editing'] else
      'pill-red'
    %}

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2 space-y-3">
        <div class="rounded-xl border border-line p-3">
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div><span class="muted">File:</span> <code>{{ job.filename }}</code></div>
            <div><span class="muted">Status:</span> <span class="pill {{ pill_class }}">{{ job.status or "—" }}</span></div>
            <div><span class="muted">Created:</span> <time class="ts" datetime="{{ job.created_at }}">{{ job.created_at }}</time></div>
            <div><span class="muted">Updated:</span> <time class="ts" datetime="{{ job.updated_at }}">{{ job.updated_at }}</time></div>
          </div>
        </div>

        {% set src = (draft.get('source', {}) if draft else {}) %}
        {% set src_file = src.get('file') if src else None %}
        {% set is_img = src_file and ((src_file|lower).endswith('.png') or (src_file|lower).endswith('.jpg') or (src_file|lower).endswith('.jpeg')) %}

        {% if is_img %}
          <div class="preview">
            <a href="{{ url_for('serve_upload', filename=src_file) }}" target="_blank" rel="noopener noreferrer">
              <img src="{{ url_for('serve_upload', filename=src_file) }}" alt="Source upload preview" />
            </a>
          </div>
        {% endif %}

        <h2 class="text-lg font-semibold mt-2 mb-2">Draft Preview</h2>
        {% if draft %}
          <pre class="rounded-xl border border-line bg-[#0a1222] p-3 overflow-auto" style="white-space: pre-wrap;">{{ draft | tojson(indent=2) }}</pre>
        {% else %}
          <em class="muted">No draft available yet.</em>
        {% endif %}
      </div>

      <aside class="space-y-2">
        <!-- Always available -->
        <a href="{{ url_for('imports_draft', job_id=job.id) }}" class="btn btn-primary w-full">Open Draft Editor</a>
        <a href="{{ url_for('imports_raw', job_id=job.id) }}" class="btn btn-secondary w-full">View Raw OCR</a>

        {% if is_img %}
          <a href="{{ url_for('serve_upload', filename=src_file) }}" target="_blank" rel="noopener noreferrer" class="btn w-full">View Source Image</a>
        {% endif %}

        <!-- Clone Draft -->
        <form action="{{ url_for('imports_clone', job_id=job.id) }}" method="post">
          <button type="submit" class="btn w-full">Clone Draft</button>
        </form>

        <!-- Export (enabled once draft_id is resolved via background fetch) -->
        <a id="export-csv"   class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export CSV</a>
        <a id="export-json"  class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export JSON</a>
        <a id="export-xlsx"  class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Download Excel</a>

        <!-- Approve (disabled if already approved/published/discarded) -->
        <form action="{{ url_for('imports_approve', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-success w-full"
                  {% if st in ['approved','published','discarded'] %}disabled{% endif %}>
            Approve Draft
          </button>
        </form>

        <!-- Discard (disabled if already discarded/approved/published) -->
        <form action="{{ url_for('imports_discard', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-danger w-full"
                  {% if st in ['discarded','approved','published'] %}disabled{% endif %}>
            Discard Draft
          </button>
        </form>
      </aside>
    </div>
  </section>

  <script>
    // Friendly timestamp formatting (keeps raw text as fallback)
    (function() {
      function fmt(d) {
        try {
          const dt = new Date((d || '').replace(' ', 'T') + 'Z');
          if (isNaN(dt)) return d;
          const opts = { month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit' };
          return dt.toLocaleString(undefined, opts).replace(',', ' ·');
        } catch { return d; }
      }
      document.querySelectorAll('time.ts').forEach(t => {
        const raw = t.getAttribute('datetime') || t.textContent || '';
        t.textContent = fmt(raw);
      });
    })();

    // Resolve the DB-backed draft_id so Export buttons can link directly.
    (async function() {
      const csvBtn  = document.getElementById('export-csv');
      const jsonBtn = document.getElementById('export-json');
      const xlsxBtn = document.getElementById('export-xlsx');

      function enable(el, href) {
        if (!el) return;
        el.href = href;
        el.removeAttribute('aria-disabled');
        el.title = '';
        el.setAttribute('download', '');
      }

      try {
        // Follow redirect to /drafts/<id>/edit and extract the id from final URL
        const res = await fetch("{{ url_for('imports_draft', job_id=job.id) }}", {
          method: "GET",
          redirect: "follow",
          credentials: "same-origin",
          headers: { "X-Requested-With": "fetch" }
        });

        const url = res.url || '';
        const m = url.match(/\/drafts\/(\d+)\/edit\/?$/);
        if (!m) throw new Error("Could not resolve draft id");
        const draftId = m[1];

        enable(csvBtn,  `/drafts/${draftId}/export.csv`);
        enable(jsonBtn, `/drafts/${draftId}/export.json`);
        enable(xlsxBtn, `/drafts/${draftId}/export.xlsx`);
      } catch (e) {
        if (csvBtn)  csvBtn.title  = 'Draft not ready yet';
        if (jsonBtn) jsonBtn.title = 'Draft not ready yet';
        if (xlsxBtn) xlsxBtn.title = 'Draft not ready yet';
      }
    })();
  </script>
{% endblock %}
