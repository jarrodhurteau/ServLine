{% extends "base.html" %}
{% block title %}Import #{{ job.id }} · ServLine{% endblock %}

{% block content %}
  <style>
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
    .pill-gray  { background:#e5e7eb; color:#374151; }
    .pill-blue  { background:#dbeafe; color:#1e40af; }
    .pill-yellow{ background:#fef3c7; color:#92400e; }
    .pill-green { background:#dcfce7; color:#065f46; }
    .pill-red   { background:#fee2e2; color:#991b1b; }
    .pill-purple{ background:#ede9fe; color:#5b21b6; }

    .preview { border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0b1220; }
    .preview img { display:block; width:100%; height:auto; }

    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 12px; font-size:.95rem; }
    .kv .k { color:var(--muted); }
    .kv code { color:#b7cdfb; }

    .btn[aria-disabled="true"] { opacity:.6; pointer-events:none; }
    .sidebar-actions { display:flex; flex-direction:column; gap:.5rem; }

    /* AI section styling */
    .ai-section { border:1px dashed var(--line); border-radius:12px; padding:10px; }
    .ai-title { font-weight:700; letter-spacing:.02em; }
    .ai-note { font-size:.9rem; color:var(--muted); margin-top:2px; }

    /* Indeterminate progress bar */
    .progress-wrap { display:none; height:10px; background:rgba(122,162,255,.15); border-radius:999px; overflow:hidden; border:1px solid var(--line); }
    .progress-bar { height:100%; width:40%; border-radius:999px; background:var(--brand, #7aa2ff); animation: indet 1.2s infinite linear; transform:translateX(-40%); }
    @keyframes indet {
      0%   { transform: translateX(-40%); }
      50%  { transform: translateX(60%); }
      100% { transform: translateX(140%); }
    }

    .preview-placeholder { color:var(--muted); font-size:.9rem; padding:.5rem 0; }
  </style>

  {# --- Structured / mapping detection: mirror imports.html --- #}
  {% set filename = job.filename or '' %}
  {% set ext = filename.split('.')[-1] | lower %}
  {% set src_type = (job.source_type or '') | lower %}
  {% set is_structured_ext = ext in ['csv', 'xlsx', 'json'] %}
  {% set is_structured_type = src_type.startswith('structured_') %}
  {% set is_structured = is_structured_ext or is_structured_type %}

  <section class="card">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="text-xl font-semibold">Import #{{ job.id }}</h1>

      {% set st = (job.status or '')|lower %}
      {% set pill_class =
        'pill-gray'   if st in ['', 'pending', 'deleted'] else
        'pill-blue'   if st in ['processing', 'restored'] else
        'pill-green'  if st in ['done', 'published', 'approved'] else
        'pill-yellow' if st in ['submitted', 'review'] else
        'pill-purple' if st in ['editing'] else
        'pill-red'
      %}
      <span id="status-pill" class="pill {{ pill_class }}">{{ (job.status or '—')|capitalize }}</span>

      <div class="ml-auto flex gap-2">
        <a href="{{ url_for('imports') }}" class="btn">Back to Imports</a>
        <a id="open-editor-btn" href="{{ url_for('imports_draft', job_id=job.id) }}" class="btn btn-primary">Open Draft Editor</a>
      </div>
    </div>

    <!-- live progress (indeterminate while processing) -->
    <div id="progress-wrap" class="progress-wrap mt-3" aria-hidden="true">
      <div class="progress-bar"></div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Main column -->
      <div class="md:col-span-2 space-y-3">
        <div class="rounded-xl border border-line p-3">
          <div class="kv">
            <div class="k">File</div>
            <div><code id="file-name">{{ job.filename }}</code></div>

            <div class="k">Created</div>
            <div><time class="ts" datetime="{{ job.created_at }}">{{ job.created_at }}</time></div>

            <div class="k">Updated</div>
            <div><time id="updated-at" class="ts" datetime="{{ job.updated_at }}">{{ job.updated_at }}</time></div>

            {% if job.restaurant_id %}
              <div class="k">Restaurant</div>
              <div>#{{ job.restaurant_id }}</div>
            {% endif %}

            {% if job.source_type %}
              <div class="k">Source</div>
              <div><code>{{ job.source_type }}</code></div>
            {% endif %}
          </div>
        </div>

        <!-- ==== Source Preview with Manual Rotate ==== -->
        <div class="rounded-xl border border-line p-3">
          <div class="flex items-center justify-between gap-2 flex-wrap">
            <strong>Source Preview (rotate if sideways)</strong>
            <form method="post" action="{{ url_for('imports_rotate_image', job_id=job.id) }}?redirect=1" class="flex gap-2">
              <button class="btn btn-sm" name="dir" value="left"  type="submit">⟲ Rotate Left</button>
              <button class="btn btn-sm" name="dir" value="right" type="submit">⟳ Rotate Right</button>
            </form>
          </div>
          <div class="preview mt-2" style="max-height:70vh; overflow:auto;">
            <div id="preview-placeholder" class="preview-placeholder">Working preview (rotatable)…</div>
            <img id="preview-img" src="" alt="Working preview (rotatable)" style="display:none;" />
          </div>
          <p class="muted mt-2">After rotating, use <em>Finalize with AI Cleanup</em> to re-OCR this rotated image.</p>
        </div>
        <!-- ==== /Source Preview ==== -->

        <details class="rounded-xl border border-line">
          <summary class="px-3 py-2 cursor-pointer select-none">Draft Preview (JSON)</summary>
          <div class="p-3 overflow-auto" style="max-height:520px">
            {% if draft %}
              <pre id="draft-json" class="rounded-xl border border-line bg-[#0a1222] p-3" style="white-space: pre-wrap;">{{ draft | tojson(indent=2) }}</pre>
            {% else %}
              <em id="draft-json-empty" class="muted">No draft available yet.</em>
            {% endif %}
          </div>
        </details>
      </div>

      <!-- Sidebar actions -->
      <aside class="sidebar-actions">
        {% if restaurants %}
          <form action="{{ url_for('imports_set_restaurant', job_id=job.id) }}" method="post" class="space-y-2">
            <label class="block text-sm">
              <span class="muted">Assign Restaurant</span>
              <select name="restaurant_id" class="cell-input w-full">
                <option value="">— Select —</option>
                {% for r in restaurants %}
                  <option value="{{ r.id }}" {% if job.restaurant_id==r.id %}selected{% endif %}>#{{ r.id }} · {{ r.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="submit" class="btn w-full">Save Assignment</button>
          </form>
        {% endif %}

        <a href="{{ url_for('imports_raw', job_id=job.id) }}" class="btn btn-ghost w-full">View Raw OCR</a>

        <form action="{{ url_for('imports_clone', job_id=job.id) }}" method="post">
          <button type="submit" class="btn w-full">Clone Draft</button>
        </form>

        {# ===== Column Mapping (detail page) ===== #}
        {% if is_structured %}
          <a
            href="{{ url_for('imports_mapping', job_id=job.id) }}"
            class="btn w-full"
          >
            Column Mapping
          </a>
        {% else %}
          <button
            type="button"
            class="btn w-full"
            aria-disabled="true"
            title="Column mapping is only available for structured CSV/XLSX/JSON imports."
          >
            Column Mapping
          </button>
        {% endif %}
        {# ======================================= #}

        <!-- ===== AI TOOLS ===== -->
        <div class="ai-section">
          <div class="ai-title">⚡ AI Tools</div>
          <div class="ai-note">
            Preview uses heuristics only (Phase A). Commit replaces current draft items.
          </div>

          <a class="btn btn-ghost w-full"
             href="{{ url_for('imports_ai_preview', job_id=job.id) }}"
             target="_blank" rel="noopener">
            AI Preview (JSON)
          </a>

          <!-- POST with redirect so no blank JSON page -->
          <form id="ai-commit-form"
                action="{{ url_for('imports_ai_finalize', job_id=job.id) }}?redirect=1"
                method="post"
                title="Automatically improve names, merge split descriptions, and clean OCR noise.">
            <button type="submit" class="btn w-full">Finalize with AI Cleanup</button>
          </form>
        </div>
        <!-- ===================== -->

        <!-- Export (enabled after resolving draft_id) -->
        <a id="export-csv"  class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export CSV</a>
        <a id="export-json" class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export JSON</a>
        <a id="export-xlsx" class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Download Excel</a>

        <form id="approve-form" action="{{ url_for('imports_approve', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-success w-full">Approve Draft</button>
        </form>

        <form id="discard-form" action="{{ url_for('imports_discard', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-danger w-full">Discard Draft</button>
        </form>
      </aside>
    </div>
  </section>

  <div id="page-data" data-job-id="{{ job.id }}"></div>

  <script>
    console.log("import_view.html (live status + preview) loaded.");

    // map status → pill class
    const PILL_CLASSES = {
      pending:  'pill-gray',
      deleted:  'pill-gray',
      processing:'pill-blue',
      restored: 'pill-blue',
      done:     'pill-green',
      approved: 'pill-green',
      published:'pill-green',
      editing:  'pill-purple',
      submitted:'pill-yellow',
      review:   'pill-yellow',
      failed:   'pill-red',
      error:    'pill-red'
    };

    const jobId = Number((document.getElementById('page-data') || {}).dataset.jobId || '0');
    const statusPill  = document.getElementById('status-pill');
    const progressWrap= document.getElementById('progress-wrap');
    const updatedAtEl = document.getElementById('updated-at');
    const previewImg  = document.getElementById('preview-img');
    const previewPh   = document.getElementById('preview-placeholder');

    const previewURL  = "{{ preview_img_url if preview_img_url else url_for('imports_preview_image', job_id=job.id) }}";
    const statusURL   = "{{ url_for('import_status', job_id=job.id) }}";

    let imgReady = false;
    function cacheBust(url){ const t = Date.now(); return url + (url.includes('?') ? '&' : '?') + 't=' + t; }

    function showPreview(src){
      previewImg.src = src;
      previewImg.onload = () => {
        imgReady = true;
        previewImg.style.display = '';
        if (previewPh) previewPh.style.display = 'none';
      };
      previewImg.onerror = () => {
        imgReady = false;
        previewImg.style.display = 'none';
        if (previewPh) previewPh.style.display = '';
      };
    }

    // initial attempt (works if the JPEG was already built)
    showPreview(cacheBust(previewURL));

    // retry the preview every 2s until it shows
    const previewTimer = setInterval(() => {
      if (imgReady) { clearInterval(previewTimer); return; }
      showPreview(cacheBust(previewURL));
    }, 2000);

    // friendly timestamp
    function fmtTime(s){
      try{
        const dt = new Date((s||'').replace(' ','T') + 'Z');
        if (isNaN(dt)) return s;
        return dt.toLocaleString(undefined, { month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit'}).replace(',', ' ·');
      }catch{ return s; }
    }
    document.querySelectorAll('time.ts').forEach(t => {
      const raw = t.getAttribute('datetime') || t.textContent || '';
      t.textContent = fmtTime(raw);
    });

    // enable export links after resolving draft id (unchanged)
    (async function resolveExports(){
      const csvBtn  = document.getElementById('export-csv');
      const jsonBtn = document.getElementById('export-json');
      const xlsxBtn = document.getElementById('export-xlsx');
      function enable(el, href){ if(!el) return; el.href = href; el.removeAttribute('aria-disabled'); el.title=''; el.setAttribute('download',''); }
      try {
        const res = await fetch("{{ url_for('imports_draft', job_id=job.id) }}", { redirect:"follow", credentials:"same-origin", headers:{ "X-Requested-With":"fetch" }});
        const m = (res.url||'').match(/\/drafts\/(\d+)\/edit\/?$/);
        if(!m) throw 0;
        const draftId = m[1];
        enable(csvBtn,  `/drafts/${draftId}/export.csv`);
        enable(jsonBtn, `/drafts/${draftId}/export.json`);
        enable(xlsxBtn, `/drafts/${draftId}/export.xlsx`);
      } catch(e){
        if (csvBtn)  csvBtn.title  = 'Draft not ready yet';
        if (jsonBtn) jsonBtn.title = 'Draft not ready yet';
        if (xlsxBtn) xlsxBtn.title = 'Draft not ready yet';
      }
    })();

    // live status poller
    const terminal = new Set(['done','approved','published','discarded','failed','error']);
    const pollMs = 1500;
    const initialStatus = '{{ (job.status or "")|lower }}';
    // Only auto-redirect if we started in a non-terminal state (i.e. we were waiting)
    const shouldAutoRedirect = !terminal.has(initialStatus);

    async function pollStatus(){
      try{
        const r = await fetch(statusURL, { credentials: 'same-origin', headers: { 'Accept': 'application/json' }});
        if(!r.ok) throw 0;
        const data = await r.json();

        // update pill
        const st = String((data.status||'').toLowerCase() || '');
        statusPill.textContent = (st ? st[0].toUpperCase()+st.slice(1) : '—');
        statusPill.className = 'pill ' + (PILL_CLASSES[st] || 'pill-gray');

        // show/hide progress bar
        if (st === 'pending' || st === 'processing'){
          progressWrap.style.display = 'block';
        } else {
          progressWrap.style.display = 'none';
        }

        // update "Updated" time if backend changed it
        if (data.updated_at && updatedAtEl){
          updatedAtEl.setAttribute('datetime', data.updated_at);
          updatedAtEl.textContent = fmtTime(data.updated_at);
        }

        // when draft becomes ready, refresh preview (bust cache) once
        if (data.draft_ready && !imgReady){
          showPreview(cacheBust(previewURL));
        }

        // auto-redirect to draft editor when processing completes
        if (st === 'done' && shouldAutoRedirect){
          const editorBtn = document.getElementById('open-editor-btn');
          if (editorBtn && editorBtn.href){
            window.location.href = editorBtn.href;
            return;
          }
        }

        // stop polling on terminal states
        if (terminal.has(st)){
          return; // stop polling
        }
      }catch(e){
        // ignore transient errors; keep polling
      }
      setTimeout(pollStatus, pollMs);
    }
    pollStatus();

    // confirms for risky actions
    (function () {
      const approve  = document.getElementById('approve-form');
      const discard  = document.getElementById('discard-form');
      const aiCommit = document.getElementById('ai-commit-form');

      approve?.addEventListener('submit', (e) => {
        if (!confirm('Approve this draft into the menu?')) e.preventDefault();
      });
      discard?.addEventListener('submit', (e) => {
        if (!confirm('Discard all items from this draft?')) e.preventDefault();
      });

      if (aiCommit) {
        aiCommit.addEventListener('submit', (e) => {
          if (!confirm('Replace current draft items with AI-cleaned items?')) {
            e.preventDefault();
            return;
          }
          if (window.showProgressBar) showProgressBar(60000, 'Finalizing with AI…');
        });
      }
    })();
  </script>
{% endblock %}
