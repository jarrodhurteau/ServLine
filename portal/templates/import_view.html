{% extends "base.html" %}
{% block title %}Import #{{ job.id }} · ServLine{% endblock %}

{% block content %}
  <style>
    /* Status pills */
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
    .pill-gray  { background:#e5e7eb; color:#374151; }
    .pill-blue  { background:#dbeafe; color:#1e40af; }
    .pill-yellow{ background:#fef3c7; color:#92400e; }
    .pill-green { background:#dcfce7; color:#065f46; }
    .pill-red   { background:#fee2e2; color:#991b1b; }
    .pill-purple{ background:#ede9fe; color:#5b21b6; }

    .preview { border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0b1220; }
    .preview img { display:block; width:100%; height:auto; }

    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 12px; font-size:.95rem; }
    .kv .k { color:var(--muted); }
    .kv code { color:#b7cdfb; }

    /* Disabled look for export buttons until draft_id is resolved */
    .btn[aria-disabled="true"] { opacity:.6; pointer-events:none; }

    /* Action column stacks nicely on narrow screens */
    .sidebar-actions { display:flex; flex-direction:column; gap:.5rem; }
  </style>

  <!-- Header card -->
  <section class="card">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="text-xl font-semibold">Import #{{ job.id }}</h1>

      {% set st = (job.status or '')|lower %}
      {% set pill_class =
        'pill-gray'   if st in ['', 'pending', 'deleted'] else
        'pill-blue'   if st in ['processing', 'restored'] else
        'pill-green'  if st in ['done', 'published', 'approved'] else
        'pill-yellow' if st in ['submitted', 'review'] else
        'pill-purple' if st in ['editing'] else
        'pill-red'
      %}
      <span class="pill {{ pill_class }}">{{ (job.status or '—')|capitalize }}</span>

      <div class="ml-auto flex gap-2">
        <a href="{{ url_for('imports') }}" class="btn">Back to Imports</a>
        <a href="{{ url_for('imports_draft', job_id=job.id) }}" class="btn btn-primary">Open Draft Editor</a>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Main column -->
      <div class="md:col-span-2 space-y-3">
        <!-- Meta -->
        <div class="rounded-xl border border-line p-3">
          <div class="kv">
            <div class="k">File</div>
            <div><code>{{ job.filename }}</code></div>

            <div class="k">Created</div>
            <div><time class="ts" datetime="{{ job.created_at }}">{{ job.created_at }}</time></div>

            <div class="k">Updated</div>
            <div><time class="ts" datetime="{{ job.updated_at }}">{{ job.updated_at }}</time></div>

            {% if job.restaurant_id %}
              <div class="k">Restaurant</div>
              <div>#{{ job.restaurant_id }}</div>
            {% endif %}
          </div>
        </div>

        {% set src = (draft.get('source', {}) if draft else {}) %}
        {% set src_file = src.get('file') if src else None %}
        {% set is_img = src_file and ((src_file|lower).endswith('.png') or (src_file|lower).endswith('.jpg') or (src_file|lower).endswith('.jpeg')) %}

        {% if is_img %}
          <div class="preview">
            <a href="{{ url_for('serve_upload', filename=src_file) }}" target="_blank" rel="noopener noreferrer">
              <img src="{{ url_for('serve_upload', filename=src_file) }}" alt="Source upload preview" />
            </a>
          </div>
        {% endif %}

        <!-- Draft JSON preview (collapsible) -->
        <details class="rounded-xl border border-line">
          <summary class="px-3 py-2 cursor-pointer select-none">Draft Preview (JSON)</summary>
          <div class="p-3 overflow-auto" style="max-height:520px">
            {% if draft %}
              <pre class="rounded-xl border border-line bg-[#0a1222] p-3" style="white-space: pre-wrap;">{{ draft | tojson(indent=2) }}</pre>
            {% else %}
              <em class="muted">No draft available yet.</em>
            {% endif %}
          </div>
        </details>
      </div>

      <!-- Sidebar actions -->
      <aside class="sidebar-actions">
        {% if restaurants %}
          <form action="{{ url_for('imports_set_restaurant', job_id=job.id) }}" method="post" class="space-y-2">
            <label class="block text-sm">
              <span class="muted">Assign Restaurant</span>
              <select name="restaurant_id" class="cell-input w-full">
                <option value="">— Select —</option>
                {% for r in restaurants %}
                  <option value="{{ r.id }}" {% if job.restaurant_id==r.id %}selected{% endif %}>#{{ r.id }} · {{ r.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="submit" class="btn w-full">Save Assignment</button>
          </form>
        {% endif %}

        <a href="{{ url_for('imports_raw', job_id=job.id) }}" class="btn btn-ghost w-full">View Raw OCR</a>

        {% if is_img %}
          <a href="{{ url_for('serve_upload', filename=src_file) }}" target="_blank" rel="noopener noreferrer" class="btn w-full">View Source Image</a>
        {% endif %}

        <!-- Clone -->
        <form action="{{ url_for('imports_clone', job_id=job.id) }}" method="post">
          <button type="submit" class="btn w-full">Clone Draft</button>
        </form>

        <!-- Export (auto-enabled once draft_id is resolved) -->
        <a id="export-csv"  class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export CSV</a>
        <a id="export-json" class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Export JSON</a>
        <a id="export-xlsx" class="btn w-full" href="#" aria-disabled="true" title="Resolving draft…">Download Excel</a>

        <!-- Approve / Discard -->
        <form id="approve-form" action="{{ url_for('imports_approve', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-success w-full"
                  {% if st in ['approved','published','discarded'] %}disabled{% endif %}>
            Approve Draft
          </button>
        </form>

        <form id="discard-form" action="{{ url_for('imports_discard', job_id=job.id) }}" method="post">
          <button type="submit" class="btn btn-danger w-full"
                  {% if st in ['discarded','approved','published'] %}disabled{% endif %}>
            Discard Draft
          </button>
        </form>
      </aside>
    </div>
  </section>

  <script>
    // Friendly timestamp formatting (keeps raw text as fallback)
    (function() {
      function fmt(d) {
        try {
          const dt = new Date((d || '').replace(' ', 'T') + 'Z');
          if (isNaN(dt)) return d;
          const opts = { month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit' };
          return dt.toLocaleString(undefined, opts).replace(',', ' ·');
        } catch { return d; }
      }
      document.querySelectorAll('time.ts').forEach(t => {
        const raw = t.getAttribute('datetime') || t.textContent || '';
        t.textContent = fmt(raw);
      });
    })();

    // Confirm dialogs for risky actions
    (function(){
      const approve = document.getElementById('approve-form');
      const discard = document.getElementById('discard-form');
      approve?.addEventListener('submit', (e)=>{
        if(!confirm('Approve this draft into the menu?')) e.preventDefault();
      });
      discard?.addEventListener('submit', (e)=>{
        if(!confirm('Discard all items from this draft? This cannot be undone.')) e.preventDefault();
      });
    })();

    // Resolve the DB-backed draft_id so Export buttons can link directly.
    (async function() {
      const csvBtn  = document.getElementById('export-csv');
      const jsonBtn = document.getElementById('export-json');
      const xlsxBtn = document.getElementById('export-xlsx');

      function enable(el, href) {
        if (!el) return;
        el.href = href;
        el.removeAttribute('aria-disabled');
        el.title = '';
        el.setAttribute('download', '');
      }

      try {
        // Follow redirect to /drafts/<id>/edit and extract the id from final URL
        const res = await fetch("{{ url_for('imports_draft', job_id=job.id) }}", {
          method: "GET",
          redirect: "follow",
          credentials: "same-origin",
          headers: { "X-Requested-With": "fetch" }
        });

        const url = res.url || '';
        const m = url.match(/\/drafts\/(\d+)\/edit\/?$/);
        if (!m) throw new Error("Could not resolve draft id");
        const draftId = m[1];

        enable(csvBtn,  `/drafts/${draftId}/export.csv`);
        enable(jsonBtn, `/drafts/${draftId}/export.json`);
        enable(xlsxBtn, `/drafts/${draftId}/export.xlsx`);
      } catch (e) {
        if (csvBtn)  csvBtn.title  = 'Draft not ready yet';
        if (jsonBtn) jsonBtn.title = 'Draft not ready yet';
        if (xlsxBtn) xlsxBtn.title = 'Draft not ready yet';
      }
    })();
  </script>
{% endblock %}
