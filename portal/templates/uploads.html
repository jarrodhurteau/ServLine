{% extends "base.html" %}
{% block title %}Uploads{% endblock %}
{% block content %}

<h1 class="mb-3">Uploads</h1>

{% if files|length == 0 %}
  <p class="muted">No files in Uploads.</p>
{% else %}
  <!-- Toolbar: SEPARATE forms, no nesting -->
  <div class="mb-3 flex flex-wrap items-center gap-2">
    <form method="post" action="{{ url_for('artifacts_sweep') }}" style="display:inline;">
      <button type="submit" class="btn btn-primary">Artifact Sweep</button>
    </form>

    <!-- Delete form has ONLY the delete button here; checkboxes live in the table form below -->
    <form id="deleteForm" method="post" action="{{ url_for('uploads_delete') }}" style="display:inline;">
      <button id="deleteBtn" type="submit" class="btn btn-danger" disabled>Delete Selected (to Recycle Bin)</button>
    </form>

    <span class="muted ml-auto">{{ files|length }} file{{ '' if files|length == 1 else 's' }}</span>
  </div>

  <!-- Table form holds the checkboxes; submit is triggered by the separate delete form via JS -->
  <form id="tableForm">
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th style="width:44px;"><input type="checkbox" id="checkAll"></th>
            <th>Filename</th>
            <th>Size</th>
            <th>Modified</th>
            <th>Preview</th>
          </tr>
        </thead>
        <tbody>
          {% for f in files %}
          <tr>
            <td><input type="checkbox" name="names" value="{{ f.name }}" class="rowcheck"></td>
            <td><code>{{ f.name }}</code></td>
            <td>{{ (f.size/1024)|round(1) }} KB</td>
            <td>{{ f.modified.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            <td>
              {% if f.name.lower().endswith(('.png','.jpg','.jpeg')) %}
                <a href="{{ url_for('serve_upload', filename=f.name) }}" target="_blank" rel="noopener">Open</a>
              {% else %}
                <em class="muted">n/a</em>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>

  <script>
    // sync "Delete Selected" button enabled state
    const deleteBtn = document.getElementById('deleteBtn');
    const checkAll = document.getElementById('checkAll');
    const rowChecks = () => Array.from(document.querySelectorAll('.rowcheck'));
    function refreshDeleteEnabled(){
      deleteBtn.disabled = !rowChecks().some(c => c.checked);
    }
    checkAll.addEventListener('change', () => {
      rowChecks().forEach(c => c.checked = checkAll.checked);
      refreshDeleteEnabled();
    });
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('rowcheck')) {
        if (!e.target.checked) checkAll.checked = false;
        refreshDeleteEnabled();
      }
    });

    // Submit the real delete POST with selected names
    document.getElementById('deleteForm').addEventListener('submit', (e) => {
      if (deleteBtn.disabled) { e.preventDefault(); return; }
      const form = document.createElement('form');
      form.method = 'post';
      form.action = "{{ url_for('uploads_delete') }}";
      rowChecks().forEach(c => {
        if (c.checked) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'names';
          input.value = c.value;
          form.appendChild(input);
        }
      });
      document.body.appendChild(form);
      form.submit();
      e.preventDefault();
    });
  </script>
{% endif %}
{% endblock %}
