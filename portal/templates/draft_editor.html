{% extends "base.html" %}
{% block title %}Draft Editor · Draft #{{ draft.id }}{% endblock %}

{% block content %}
<div class="draft-editor-page">
  <style>
    /* ===== Confidence Heat-Map & Provenance ===== */
    #items-body tr.conf-row.conf-high    { background: linear-gradient(to right, rgba(40, 167, 69, 0.10),  transparent 30%); }
    #items-body tr.conf-row.conf-med     { background: linear-gradient(to right, rgba(255, 193, 7, 0.10),   transparent 30%); }
    #items-body tr.conf-row.conf-low     { background: linear-gradient(to right, rgba(220, 53, 69, 0.10),   transparent 30%); }
    #items-body tr.conf-row.conf-unknown { background: none; }

    .prov-pin {
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px; border-radius:50%;
      border:1px solid var(--line); color:var(--muted); font-size:11px;
      margin-left:6px; cursor:help; user-select:none;
      background: rgba(255,255,255,0.04);
    }
    .prov-pin:hover { color: var(--ink); border-color: var(--brand); }

    .prov-tip {
      position: fixed; z-index: 9999; pointer-events: none;
      background: #0e1628; color: var(--ink); border:1px solid var(--line);
      border-radius: 10px; padding:10px 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
      font-size: .85rem; min-width: 240px; max-width: 420px; display:none;
    }
    .prov-tip .head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .prov-tip .dot { width:8px; height:8px; border-radius:50%; }
    .prov-tip .dot.high { background:#28a745; }
    .prov-tip .dot.med  { background:#ffc107; }
    .prov-tip .dot.low  { background:#dc3545; }
    .prov-tip .kv { display:grid; grid-template-columns: 96px 1fr; gap:4px 10px; color: var(--muted); }
    .prov-tip .kv b { color: var(--ink); font-weight:600; }
    .prov-tip .links { margin-top:8px; display:flex; gap:10px; }
    .prov-tip a { color:#b7cdfb; text-decoration:none; }
    .prov-tip a:hover { text-decoration:underline; }

    .conf-badge { margin-left:6px; padding:2px 6px; border-radius:8px; font-size:.75rem; font-weight:600; }
    .conf-high { background: rgba(40,167,69,.15); color:#9ae6b4; border:1px solid rgba(40,167,69,.35); }
    .conf-med  { background: rgba(255,193,7,.14); color:#ffe08a; border:1px solid rgba(255,193,7,.35); }
    .conf-low  { background: rgba(220,53,69,.14); color:#ffb3b8; border:1px solid rgba(220,53,69,.35); }

    .row-focus { outline: 2px solid var(--brand); outline-offset: -2px; }

    /* Helper note under publish */
    .helper-note { color: var(--muted); font-size: .85rem; margin-top: 6px; }

    /* Sidebar containment */
    .sidebar {
      position: sticky; top: 80px; max-height: calc(100vh - 100px);
      overflow-y: auto; overflow-x: hidden; background: rgba(20,20,30,0.85);
      padding-right: 6px; z-index: 5;
    }

    /* Export dropdown */
    details.export { position: relative; }
    details.export .menu{
      position:absolute; right:0; top:calc(100% + 6px); z-index:1000 !important;
      background:#1a2236; border:1px solid #2b3552; border-radius:8px; padding:8px 10px; min-width:240px;
      box-shadow:0 12px 24px rgba(0,0,0,0.35);
    }
    details.export .menu a, details.export .menu button{
      display:block; color:#cbd5e1; text-align:left; padding:6px 4px; width:100%;
      background:transparent; border:none; cursor:pointer; font-size:.9rem;
    }
    details.export .menu a:hover, details.export .menu button:hover{ color:#fff; }

    /* ===== Status pill (parity with import view) ===== */
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
    .pill-gray  { background:#e5e7eb; color:#374151; }
    .pill-blue  { background:#dbeafe; color:#1e40af; }
    .pill-yellow{ background:#fef3c7; color:#92400e; }
    .pill-green { background:#dcfce7; color:#065f46; }
    .pill-red   { background:#fee2e2; color:#991b1b; }
    .pill-purple{ background:#ede9fe; color:#5b21b6; }

    /* Confidence threshold slider */
    .confidence-filter {
      display:flex;
      align-items:center;
      gap:6px;
      margin-left:16px;
      color:var(--muted);
      font-size:.85rem;
      white-space:nowrap;
    }
    .confidence-filter input[type="range"] {
      width:140px;
    }

    /* ===== Low Confidence Bucket (Phase 3 pt.7) ===== */
    .low-conf-panel {
      margin-bottom: 1.25rem;
      padding: 0.75rem 1rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(248, 113, 113, 0.4);
      background: linear-gradient(to right,
        rgba(248, 113, 113, 0.13),
        rgba(15, 23, 42, 0.9)
      );
    }
    .low-conf-header {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }
    .low-conf-header-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #fecaca;
      letter-spacing: .02em;
      text-transform: uppercase;
    }
    .low-conf-sub {
      font-size: 0.8rem;
      color: #e5e7eb;
      opacity: 0.8;
    }
    .low-conf-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem 0.75rem;
    }
    .low-conf-list li {
      font-size: 0.82rem;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .low-conf-list .lc-name {
      font-weight: 600;
    }
    .low-conf-list .lc-cat {
      font-size: 0.75rem;
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.2);
      color: #bfdbfe;
    }
    .low-conf-list .lc-score {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .pill-low {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      background: rgba(248, 113, 113, 0.16);
      border: 1px solid rgba(248, 113, 113, 0.8);
      color: #fecaca;
      white-space: nowrap;
    }
    .pill-low-mini {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      background: rgba(248, 113, 113, 0.18);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
      white-space: nowrap;
    }

    /* Subtle marker on low-confidence rows */
    #items-body tr.conf-row.is-low {
      box-shadow: inset 2px 0 0 rgba(248, 113, 113, 0.8);
    }
    #items-body tr.conf-row.is-low:hover {
      box-shadow:
        inset 2px 0 0 rgba(248, 113, 113, 0.9),
        0 0 0 1px rgba(248, 113, 113, 0.4);
    }

    .quality-meta {
      font-size: 0.72rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    .name-cell .name-main {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      flex-wrap: wrap;
    }
  </style>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>Menu Outline</h3>
      <ul id="outline" class="tree"></ul>

      <hr style="border-color:#1f2a44; margin:12px 0;">
      <h3>Actions</h3>

      <!-- Assign Restaurant -->
      <form action="{{ url_for('draft_assign_restaurant', draft_id=draft.id) }}" method="post" style="display:grid; gap:8px;">
        <label for="restaurant_id" style="color:var(--muted); font-size:.9rem;">Assign Restaurant</label>
        <select id="restaurant_id" name="restaurant_id" class="cell-input" {% if draft.status != 'editing' %}disabled{% endif %}>
          {% for r in restaurants %}
            <option value="{{ r.id }}" {% if draft.restaurant_id == r.id %}selected{% endif %}>{{ r.name }} ({{ r.id }})</option>
          {% endfor %}
        </select>
        <button class="btn btn-secondary" {% if draft.status != 'editing' %}disabled{% endif %}>Save Assignment</button>
      </form>

      <!-- Publish -->
      <form action="{{ url_for('draft_publish_now', draft_id=draft.id) }}" method="post" style="margin-top:10px;">
        <button class="btn btn-success">Publish to Menu</button>
        {% if not draft.restaurant_id %}
          <div class="helper-note">Tip: assign a restaurant first (above) so items publish to the right menu.</div>
        {% endif %}
      </form>

      <!-- OCR Debug -->
      <hr style="border-color:#1f2a44; margin:12px 0;">
      <h3>OCR Debug</h3>
      <div style="display:grid; gap:6px;">
        <a class="btn" href="{{ url_for('draft_ocr_debug_json', draft_id=draft.id) }}">View OCR Debug (JSON)</a>
        <a class="btn" href="{{ url_for('draft_ocr_debug_csv',  draft_id=draft.id) }}">Download OCR Debug (CSV)</a>
      </div>

      {% if draft.source_job_id %}
        <hr style="border-color:#1f2a44; margin:12px 0%;">
        <a class="btn" href="{{ url_for('imports_detail', job_id=draft.source_job_id) }}">Back to Import Detail</a>
      {% endif %}
    </aside>

    <!-- MAIN -->
    <div class="draft-editor">
      <div class="page-header">
        <div class="infobar">
          <span class="chip"><span class="label">Draft #</span><span class="value">{{ draft.id }}</span></span>
          {% if draft.restaurant_id is not none %}
            <span class="chip"><span class="label">Restaurant</span><span class="value">#{{ draft.restaurant_id }}</span></span>
          {% endif %}
          {% if draft.source %}
            {% set src = (draft.source|string) %}
            <span class="chip"><span class="label">Source</span><span class="value">{{ src[:24] }}{% if src|length > 24 %}…{% endif %}</span></span>
          {% endif %}
          {% if draft.source_job_id %}
            <span class="chip"><span class="label">Import Job</span><span class="value">#{{ draft.source_job_id }}</span></span>
          {% endif %}
          <span class="chip"><span class="label">Last saved</span><span id="last-saved" class="value">{{ draft.updated_at }}</span></span>

          {% set s = (draft.status or 'editing') %}
          <span class="pill
            {% if s=='editing' %}pill-blue
            {% elif s in ['review','reviewing'] %}pill-yellow
            {% elif s in ['finalizing','finalize'] %}pill-purple
            {% elif s in ['published','complete','approved'] %}pill-green
            {% elif s in ['failed','error'] %}pill-red
            {% else %}pill-gray{% endif %}">
            {{ s }}
          </span>

          <input id="draft-title" class="title-input" value="{{ draft.title|e }}" {% if draft.status != 'editing' %}disabled{% endif %} />
          <span id="dirty-indicator" class="badge dirty">Unsaved changes</span>

          <div style="margin-left:auto; display:flex; gap:8px; align-items:center; white-space:nowrap;">
            {% if draft.source_job_id %}
              <a class="btn" target="_blank" rel="noopener" href="{{ url_for('imports_ai_preview', job_id=draft.source_job_id) }}">AI Preview (heuristics)</a>
            {% endif %}
            <a class="btn" href="{{ url_for('drafts_list') }}">Back to Drafts</a>

            <details class="export">
              <summary class="btn">Export ▾</summary>
              <div class="menu">
                <a href="{{ url_for('draft_export_csv',  draft_id=draft.id) }}">Download CSV (all rows)</a>
                <a href="{{ url_for('draft_export_json', draft_id=draft.id) }}">Download JSON (all rows)</a>
                <a href="{{ url_for('draft_export_xlsx', draft_id=draft.id) }}">Download Excel (all rows)</a>
                <a href="{{ url_for('draft_ocr_debug_csv', draft_id=draft.id) }}">Download OCR Debug (CSV)</a>
                <button type="button" id="export-visible-btn">Export Visible as CSV</button>
              </div>
            </details>

            <!-- Clean & Refine = Fix Descriptions + Clean with AI -->
            <form id="refine-form" action="#" method="post" style="display:inline;">
              <button class="btn btn-secondary" title="Join split lines, merge descriptions, and polish OCR noise.">✨ Clean & Refine</button>
            </form>

            <!-- Finalize with AI Cleanup (form → redirect + status pill) -->
            {% if draft.source_job_id %}
              <form id="finalize-ai-form"
                    action="{{ url_for('imports_ai_commit', job_id=draft.source_job_id) }}?redirect=1"
                    method="post"
                    style="display:inline-flex; align-items:center; gap:8px;">
                <button class="btn btn-secondary" id="finalize-ai-btn"
                        title="Finalize with AI cleanup — merge and polish items">
                  ✨ Finalize with AI Cleanup
                </button>
                <span id="finalize-status" class="pill pill-gray" style="display:none;">Idle</span>
              </form>
            {% else %}
              <button class="btn btn-secondary" title="No import job linked to this draft" disabled>
                ✨ Finalize with AI Cleanup
              </button>
            {% endif %}

            <button id="save-btn" class="btn btn-primary" {% if draft.status != 'editing' %}disabled{% endif %}>Save</button>
          </div>
        </div>
      </div>

      <!-- Flash banners -->
      <div id="error-banner" class="error-banner"></div>
      <div id="success-banner" class="success-banner"></div>

      <!-- Sticky toolbar -->
      <div class="toolbar-sticky">
        <div class="search-wrap">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="search" class="cell-input search" placeholder="Search items… (name, description, category)" />
        </div>

        <!-- Confidence threshold slider -->
        <div class="confidence-filter">
          <span>Min confidence:</span>
          <input type="range"
                 id="confidence-threshold"
                 min="0" max="100" step="5" />
          <span id="confidence-threshold-value">0%</span>
        </div>

        <div class="spacer"></div>
        <button id="add-row-btn" class="btn">Add Item</button>
        <button id="delete-selected-btn" class="btn btn-danger">Delete Selected</button>
      </div>

      {# === Low Confidence Bucket (Phase 3 pt.7) === #}
      {% set q_thresh = quality_threshold|default(65) %}
      {% if low_conf_items is defined and low_conf_items %}
      <section class="low-conf-panel">
        <div class="low-conf-header">
          <span class="low-conf-header-title">Low Confidence Items</span>
          <span class="low-conf-sub">
            {{ low_conf_items|length }} item{{ low_conf_items|length != 1 and 's' or '' }}
            scored &lt; {{ q_thresh }}/100. Review these first.
          </span>
        </div>
        <ul class="low-conf-list">
          {% for it in low_conf_items %}
          <li>
            <span class="lc-name">{{ it.name or "Untitled" }}</span>
            {% if it.category %}
              <span class="lc-cat">{{ it.category }}</span>
            {% endif %}
            {% if it.quality is not none %}
              <span class="lc-score">{{ it.quality }}/100</span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      <div class="table-wrap">
        <table class="editor" id="items-table">
          <thead>
            <tr>
              <th style="width:38px;"><input type="checkbox" id="select-all" /></th>
              <th style="min-width:220px;">Name</th>
              <th style="min-width:320px;">Description</th>
              <th style="min-width:120px;">Price</th>
              <th style="min-width:160px;">Category</th>
              <th style="min-width:90px;">Position</th>
              <th style="min-width:170px;">Actions</th>
            </tr>
          </thead>
          <tbody id="items-body">
            {% for it in items %}
            <tr class="conf-row {% if it.confidence is not none %}{{ it.confidence|confidence_class }}{% else %}conf-unknown{% endif %}{% if it.low_confidence %} is-low{% endif %}"
                data-id="{{ it.id }}"
                data-cat="{{ (it.category or '')|e }}"
                data-confidence="{{ it.confidence if it.confidence is not none else '' }}">
              <td><input type="checkbox" class="row-select" /></td>
              <td>
                <div class="name-cell">
                  <div class="name-main">
                    <textarea rows="1"
                              class="cell-textarea name-text name name-input js-autosize prewrap text-wrap"
                              data-autosize
                              {% if draft.status != 'editing' %}disabled{% endif %}>{{ it.name|e }}</textarea>
                    {% if it.confidence is not none %}
                      {% set conf = it.confidence|int %}
                      {% if conf >= 80 %}
                        <span class="conf-badge conf-high">{{ conf }}%</span>
                      {% elif conf >= 60 %}
                        <span class="conf-badge conf-med">{{ conf }}%</span>
                      {% else %}
                        <span class="conf-badge conf-low">{{ conf }}%</span>
                      {% endif %}
                    {% endif %}
                    {% if it.low_confidence %}
                      <span class="pill-low-mini">⚠ Low</span>
                    {% endif %}
                  </div>
                  {% if it.quality is not none %}
                    <div class="quality-meta">
                      Quality: {{ it.quality }}/100
                    </div>
                  {% endif %}
                  <span class="prov-pin"
                        title="Source & confidence"
                        data-prov-name="{{ (it.name or '')|e }}"
                        data-prov-cat="{{ (it.category or '(Uncategorized)')|e }}"
                        data-prov-conf="{{ it.confidence if it.confidence is not none else '' }}"
                        data-prov-pos="{{ it.position if it.position is not none else '' }}">i</span>
                </div>
              </td>
              <td>
                <textarea rows="1"
                          class="cell-textarea desc-text description js-autosize prewrap text-wrap"
                          data-autosize
                          {% if draft.status != 'editing' %}disabled{% endif %}>{{ (it.description or '')|e }}</textarea>
              </td>
              <td><input class="cell-input cell-price price"
                         value="{{ '%.2f'|format((it.price_cents|default(0,true)|int) / 100.0) }}"
                         inputmode="decimal"
                         {% if draft.status != 'editing' %}disabled{% endif %} /></td>
              <td><input list="category-datalist" class="cell-input category"
                         value="{{ (it.category or '')|e }}"
                         {% if draft.status != 'editing' %}disabled{% endif %} /></td>
              <td><input class="cell-input cell-number position"
                         value="{{ it.position if it.position is not none else '' }}"
                         inputmode="numeric"
                         {% if draft.status != 'editing' %}disabled{% endif %} /></td>
              <td class="row-actions">
                <button class="btn duplicate-btn" {% if draft.status != 'editing' %}disabled{% endif %}>Duplicate</button>
                <button class="btn btn-danger delete-btn" {% if draft.status != 'editing' %}disabled{% endif %}>Delete</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <datalist id="category-datalist">
        {% for c in categories %}
          <option value="{{ c|e }}"></option>
        {% endfor %}
        <option value="(Uncategorized)"></option>
      </datalist>

      <p class="helper" style="margin-top:10px;">Shortcuts: <strong>Ctrl/Cmd+S</strong> Save · <strong>Delete</strong> Delete selected.</p>
      <div id="toast" class="toast"></div>
    </div>
  </div>

  <!-- Expose minimal meta -->
  <script id="draft-meta" type="application/json">
    {{ {"id": draft.id, "status": draft.status, "source_job_id": draft.source_job_id}|tojson }}
  </script>

  <div id="prov-tip" class="prov-tip" role="tooltip" aria-hidden="true"></div>

  <script>
  (function(){
    const meta = JSON.parse(document.getElementById('draft-meta').textContent || '{}');
    const draftId = Number(meta.id);
    const isEditable = String(meta.status||'') === 'editing';
    const sourceJobId = meta.source_job_id ? Number(meta.source_job_id) : null;

    const $  = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

    const itemsBody = $("#items-body");
    const outline = $("#outline");
    const saveBtn = $("#save-btn");
    const titleInput = $("#draft-title");
    const dirtyIndicator = $("#dirty-indicator");
    const errorBanner = $("#error-banner");
    const successBanner = $("#success-banner");
    const toast = $("#toast");
    const selectAll = $("#select-all");
    const search = $("#search");
    const lastSaved = $("#last-saved");
    const exportVisibleBtn = $("#export-visible-btn");
    const provTip = $("#prov-tip");
    const confSlider = $("#confidence-threshold");
    const confValue = $("#confidence-threshold-value");

    const CONF_LS_KEY = 'draft_conf_threshold_v1';

    let dirty = false;
    let deletedIds = [];

    // Initialize confidence slider from localStorage
    if (confSlider && confValue) {
      let initial = 0;
      try {
        const stored = window.localStorage && window.localStorage.getItem(CONF_LS_KEY);
        if (stored !== null && !Number.isNaN(Number(stored))) {
          initial = Number(stored);
        }
      } catch (_) {}
      confSlider.value = String(initial);
      confValue.textContent = initial + '%';
    }

    /* Clean & Refine sequence */
    const refineForm = document.getElementById('refine-form');
    if (refineForm) {
      refineForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          if (window.showProgressBar) showProgressBar(30000, 'Cleaning & refining…');

          await fetch('{{ url_for("fix_descriptions_for_draft", draft_id=draft.id) }}', {
            method: 'POST', credentials: 'same-origin'
          });
          await fetch('{{ url_for("cleanup_draft", draft_id=draft.id) }}', {
            method: 'POST', credentials: 'same-origin'
          });
        } catch (err) {
          console.error('Refine error:', err);
        } finally {
          window.location.reload();
        }
      });
    }

    function setDirty(v){ dirty=!!v; dirtyIndicator.style.display = dirty? "inline-block":"none"; }
    function showToast(msg){ toast.textContent=msg; toast.style.display="block"; setTimeout(()=>toast.style.display="none", 1800); }
    function showError(msg){ errorBanner.textContent=msg; errorBanner.style.display="block"; successBanner.style.display="none"; }
    function showSuccess(msg){ successBanner.textContent=msg; successBanner.style.display="block"; errorBanner.style.display="none"; setTimeout(()=>successBanner.style.display="none", 2200); }
    function dollarsToCents(val){ if (val==null) return 0; let s=String(val).trim().replace(/[$,]/g,""); if (!s) return 0; const n=Number(s); return Number.isNaN(n)?0:Math.round(n*100); }

    function autosize(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
    $$(".desc-text, .name-text").forEach(ta=>{ autosize(ta); ta.addEventListener('input',()=>autosize(ta)); });

    function applyConfidenceTint(){
      $$("#items-body tr").forEach(tr=>{
        tr.classList.remove("conf-high","conf-med","conf-low","conf-unknown","conf-row");
        const raw = tr.getAttribute("data-confidence");
        tr.classList.add("conf-row");
        if (!raw) {
          tr.classList.add("conf-unknown");
          return;
        }
        const c = Number(raw);
        if (Number.isNaN(c)) {
          tr.classList.add("conf-unknown");
          return;
        }
        if (c >= 80) tr.classList.add("conf-high");
        else if (c >= 50) tr.classList.add("conf-med");
        else if (c > 0) tr.classList.add("conf-low");
        else tr.classList.add("conf-unknown");
      });
    }

    function collectRowsFiltered(){
      const q = search.value.trim().toLowerCase();
      const threshold = confSlider ? Number(confSlider.value || 0) : 0;

      $$("#items-body tr").forEach(tr=>{
        const name=$(".name", tr)?.value?.toLowerCase()||"";
        const desc=$(".description", tr)?.value?.toLowerCase()||"";
        const cat =(tr.getAttribute("data-cat")||"").toLowerCase();

        const passCat = tr.dataset.filterCat ? (cat === tr.dataset.filterCat) : true;
        const passItem = tr.dataset.filterItem ? (normalizeBaseName($(".name", tr)?.value||"") === tr.dataset.filterItem) : true;

        const hit = (!q || name.includes(q) || desc.includes(q) || cat.includes(q));

        const confRaw = tr.getAttribute("data-confidence") || "";
        const confNum = confRaw === "" ? null : Number(confRaw);
        const passConf = (confNum === null) ? true : (confNum >= threshold);

        tr.style.display = (passCat && passItem && hit && passConf) ? "" : "none";
      });
    }

    const sizeRx = /(.*)\s*\(([^)]+)\)\s*$/;
    function normalizeBaseName(name){ const m = name.match(sizeRx); const base = (m ? m[1] : name).trim(); return base.toLowerCase(); }

    function gatherData(){
      const data = {};
      $$("#items-body tr").forEach(tr=>{
        const rowId = tr.getAttribute("data-id");
        const cat = ($(".category", tr)?.value || tr.getAttribute("data-cat") || "").trim() || "(Uncategorized)";
        const fullName = $(".name", tr)?.value || "";
        const priceStr = $(".price", tr)?.value || "";
        const price = dollarsToCents(priceStr)/100;
        const m = fullName.match(sizeRx);
        const base = (m ? m[1] : fullName).trim();
        const sizeLabel = m ? m[2].trim() : null;

        data[cat] ||= {};
        data[cat][base] ||= { rows: [], sizes: [] };
        data[cat][base].rows.push(rowId);
        if (sizeLabel){ data[cat][base].sizes.push({ label: sizeLabel, rowId, price }); }
      });
      return data;
    }

    function clearAllFilters(){ $$("#items-body tr").forEach(tr=>{ delete tr.dataset.filterCat; delete tr.dataset.filterItem; }); }
    function setFilterByCategory(cat){ clearAllFilters(); if (cat==="__ALL__"){ collectRowsFiltered(); return; } $$("#items-body tr").forEach(tr=>{ tr.dataset.filterCat = cat.toLowerCase(); }); collectRowsFiltered(); }
    function setFilterByItem(cat, baseNorm){ clearAllFilters(); $$("#items-body tr").forEach(tr=>{ tr.dataset.filterCat = cat.toLowerCase(); tr.dataset.filterItem = baseNorm; }); collectRowsFiltered(); }

    function focusRow(rowId){
      const tr = document.querySelector(`#items-body tr[data-id="${CSS.escape(rowId)}"]`);
      if (!tr) return;
      tr.scrollIntoView({behavior:"smooth", block:"center"});
      tr.classList.add("row-focus");
      setTimeout(()=>tr.classList.remove("row-focus"), 1200);
    }

    function rebuildOutline(){
      const data = gatherData();
      const cats = Object.keys(data).sort((a,b)=>{
        const au = a === "(Uncategorized)", bu = b === "(Uncategorized)";
        if (au && !bu) return 1; if (!au && bu) return -1;
        return a.localeCompare(b);
      });

      const outline = document.getElementById("outline");
      outline.innerHTML = "";

      const liAll = document.createElement("li");
      liAll.className = "cat";
      liAll.innerHTML = `<div class="row" data-cat="__ALL__"><strong>All</strong><span class="count">${$$("#items-body tr").length}</span></div>`;
      outline.appendChild(liAll);

      liAll.querySelector(".row").addEventListener("click", ()=>{
        $$("#outline .cat").forEach(e=>e.classList.remove("active"));
        liAll.classList.add("active");
        setFilterByCategory("__ALL__");
      });

      cats.forEach(cat=>{
        const items = data[cat];
        const itemNames = Object.keys(items).sort((a,b)=>a.localeCompare(b));

        const li = document.createElement("li");
        li.className = "cat";
        const totalCount = itemNames.reduce((acc, n)=>acc + items[n].rows.length, 0);
        li.innerHTML = `<div class="row"><strong>${cat}</strong><span class="count">${totalCount}</span></div>`;
        const ulItems = document.createElement("ul");
        ulItems.className = "items";

        li.querySelector(".row").addEventListener("click", ()=>{
          $$("#outline .cat").forEach(e=>e.classList.remove("active"));
          li.classList.add("active");
          setFilterByCategory(cat);
        });

        itemNames.forEach(base=>{
          const entry = items[base];
          const liItem = document.createElement("li");
          liItem.className = "item";
          liItem.innerHTML = `<div class="row"><span>${base}</span><span class="count">${entry.rows.length}</span></div>`;

          liItem.querySelector(".row").addEventListener("click", (e)=>{
            e.stopPropagation();
            $$("#outline .item").forEach(x=>x.classList.remove("active"));
            liItem.classList.add("active");
            setFilterByItem(cat, base.toLowerCase());
          });

          if (entry.sizes.length){
            const sizesDiv = document.createElement("div");
            sizesDiv.className = "sizes";
            entry.sizes.forEach(s=>{
              const pill = document.createElement("span");
              pill.className = "size-pill";
              pill.textContent = `${s.label}: ${s.price.toFixed(2)}`;
              pill.title = "Jump to row";
              pill.addEventListener("click", (ev)=>{ ev.stopPropagation(); focusRow(s.rowId); });
              sizesDiv.appendChild(pill);
            });
            liItem.appendChild(sizesDiv);
          }

          ulItems.appendChild(liItem);
        });

        li.appendChild(ulItems);
        outline.appendChild(li);
      });
    }

    /* -------- Save / Edit / Ops -------------------------------------- */
    function collectPayload(){
      const items = [];
      let errors = [];
      $$("#items-body tr").forEach(tr=>{
        if (tr.style.display === "none") return;
        const idAttr=tr.getAttribute("data-id");
        const id = idAttr && /^\d+$/.test(idAttr) ? Number(idAttr) : (idAttr||null);
        const name=$(".name", tr).value.trim();
        const description=$(".description", tr).value.trim();
        const priceStr=$(".price", tr).value.trim();
        const category=$(".category", tr).value.trim();
        const posStr=$(".position", tr).value.trim();
        const confStr=tr.getAttribute("data-confidence");
        if (!name){ errors.push("Name is required for all items."); tr.classList.add("row-error"); } else { tr.classList.remove("row-error"); }
        const price_cents=dollarsToCents(priceStr);
        let position=null; if (posStr!==""){ const p=Number(posStr); if (Number.isNaN(p) || !Number.isInteger(p)){ errors.push("Position must be an integer."); } else { position=p; } }
        const confidence = confStr && /^\d+$/.test(confStr) ? Number(confStr) : null;
        items.push({ id, name, description, price_cents, category: category||null, position, confidence });
      });
      const title = $("#draft-title").value.trim();
      return { title, items, errors };
    }

    async function saveNow(){
      if (!isEditable) return;
      const { title, items, errors } = collectPayload();
      if (errors.length){ showError(errors[0]); return; }
      try{
        const res = await fetch(`/drafts/${draftId}/save`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ title, items, deleted_item_ids: deletedIds })
        });
        const data = await res.json();
        if (!res.ok || data.ok===false) throw new Error(data.error || "Save failed");
        let insIdx=0;
        $$("#items-body tr").forEach(tr=>{
          const idAttr=tr.getAttribute("data-id");
          if (!idAttr || !/^\d+$/.test(idAttr)){
            const newId = data.inserted_ids?.[insIdx++]; if (newId) tr.setAttribute("data-id", String(newId));
          }
        });
        lastSaved.textContent = data.saved_at || new Date().toISOString();
        setDirty(false); deletedIds=[];
        showSuccess("Saved");
        rebuildOutline();
      } catch(e){ showError(String(e)); }
    }

    if (isEditable){
      itemsBody.addEventListener("input", ()=>{ setDirty(true); applyConfidenceTint(); });
      titleInput.addEventListener("input", ()=>setDirty(true));
      saveBtn.addEventListener("click", (e)=>{ e.preventDefault(); saveNow(); });
      document.addEventListener("keydown", (e)=>{
        const mod = e.metaKey || e.ctrlKey;
        if (mod && e.key === "s"){ e.preventDefault(); saveNow(); }
        else if (e.key === "Delete"){ e.preventDefault(); deleteSelected(); }
      });
    }

    $("#search").addEventListener("input", collectRowsFiltered);

    if (confSlider && confValue) {
      confSlider.addEventListener("input", () => {
        const v = Number(confSlider.value || 0);
        confValue.textContent = v + '%';
        try {
          window.localStorage && window.localStorage.setItem(CONF_LS_KEY, String(v));
        } catch (_) {}
        collectRowsFiltered();
      });
    }

    // row ops
    let rowSeq=1; function newTempId(){ return "tmp-"+(rowSeq++); }
    function addRow(prefill={}){
      const tr=document.createElement("tr");
      tr.className = "conf-row";
      tr.setAttribute("data-id", newTempId());
      tr.setAttribute("data-cat", (prefill.category||""));
      tr.setAttribute("data-confidence", prefill.confidence!=null? String(prefill.confidence):"");
      tr.innerHTML = `
        <td><input type="checkbox" class="row-select" /></td>
        <td>
          <div class="name-cell">
            <div class="name-main">
              <textarea rows="1" class="cell-textarea name-text name name-input js-autosize prewrap text-wrap" data-autosize>${(prefill.name||"")
                .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea>
              ${prefill.confidence!=null ? `<span class="conf-badge ${prefill.confidence>=80?'conf-high':(prefill.confidence>=60?'conf-med':'conf-low')}">${prefill.confidence}%</span>` : ``}
              ${prefill.low_confidence ? `<span class="pill-low-mini">⚠ Low</span>` : ``}
            </div>
            <span class="prov-pin"
                  title="Source & confidence"
                  data-prov-name="${(prefill.name||'').replace(/"/g,'&quot;')}"
                  data-prov-cat="${(prefill.category||'(Uncategorized)').replace(/"/g,'&quot;')}"
                  data-prov-conf="${prefill.confidence!=null? String(prefill.confidence): ''}"
                  data-prov-pos="${prefill.position!=null? String(prefill.position): ''}">i</span>
          </div>
        </td>
        <td><textarea rows="1" class="cell-textarea desc-text description js-autosize prewrap text-wrap" data-autosize>${(prefill.description||"")
            .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea></td>
        <td><input class="cell-input cell-price price" value="${prefill.price_cents!=null? (prefill.price_cents/100).toFixed(2): ''}" inputmode="decimal" /></td>
        <td><input list="category-datalist" class="cell-input category" value="${(prefill.category||"").replace(/"/g,'&quot;')}" /></td>
        <td><input class="cell-input cell-number position" value="${prefill.position!=null? prefill.position:''}" inputmode="numeric" /></td>
        <td class="row-actions">
          <button class="btn duplicate-btn">Duplicate</button>
          <button class="btn btn-danger">Delete</button>
        </td>`;
      itemsBody.prepend(tr);
      const taDesc=$(".desc-text", tr); if (taDesc){ autosize(taDesc); taDesc.addEventListener('input',()=>autosize(taDesc)); }
      const taName=$(".name-text", tr); if (taName){ autosize(taName); taName.addEventListener('input',()=>autosize(taName)); }
      setDirty(true); rebuildOutline(); applyConfidenceTint(); wireRowProvPins(tr);
      return tr;
    }

    $("#add-row-btn").addEventListener("click",(e)=>{ e.preventDefault(); const tr=addRow({position:0}); $(".name", tr)?.focus(); });

    itemsBody.addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const tr=e.target.closest("tr"); if(!tr) return;
      if (btn.classList.contains("duplicate-btn")){
        const clone=tr.cloneNode(true); clone.setAttribute("data-id", newTempId());
        const nameEl=$(".name", clone); if(nameEl) nameEl.value=(nameEl.value||"")+" (copy)";
        itemsBody.insertBefore(clone, tr.nextSibling);
        const ta=$(".desc-text", clone); if(ta){ autosize(ta); ta.addEventListener('input',()=>autosize(ta)); }
        const taN=$(".name-text", clone); if(taN){ autosize(taN); taN.addEventListener('input',()=>autosize(taN)); }
        setDirty(true); showToast("Duplicated"); rebuildOutline(); applyConfidenceTint(); wireRowProvPins(clone);
      } else if (btn.classList.contains("btn-danger")){
        queueDelete(tr); tr.remove(); setDirty(true); showToast("Deleted"); rebuildOutline(); applyConfidenceTint();
      }
    });

    function queueDelete(tr){ const idAttr=tr.getAttribute("data-id"); if (idAttr && /^\d+$/.test(idAttr)) deletedIds.push(Number(idAttr)); }

    selectAll?.addEventListener("change", ()=>{ const checked=selectAll.checked; $$(".row-select").forEach(cb=>cb.checked=checked); });
    $("#delete-selected-btn").addEventListener("click", (e)=>{
      e.preventDefault();
      const selected=$$(".row-select").filter(cb=>cb.checked).map(cb=>cb.closest("tr"));
      if (!selected.length) return;
      selected.forEach(tr=>{ queueDelete(tr); tr.remove(); });
      setDirty(true); showToast(`Deleted ${selected.length} item(s)`); 
      rebuildOutline(); applyConfidenceTint();
    });

    itemsBody.addEventListener("blur",(e)=>{
      const el=e.target;
      if (el && el.classList.contains("price")){ const cents=dollarsToCents(el.value); el.value=(cents/100).toFixed(2); }
      if (el && el.classList.contains("category")){ const tr=el.closest("tr"); if (tr) tr.setAttribute("data-cat", el.value || ""); rebuildOutline(); }
      if (el && el.classList.contains("name")){ rebuildOutline(); }
    }, true);

    window.addEventListener("beforeunload",(e)=>{ if (dirty && isEditable){ e.preventDefault(); e.returnValue=""; } });

    // Heartbeat
    let pingTimer=null;
    function startHeartbeat(){ if (!isEditable) return; stopHeartbeat(); pingTimer=setInterval(async ()=>{ if (document.hidden) return; try{ const res=await fetch(`/drafts/${draftId}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({autosave_ping:true})}); if (res.ok){ const data=await res.json(); if (data && data.saved_at && lastSaved) lastSaved.textContent=data.saved_at; } }catch(_){ } },30000); }
    function stopHeartbeat(){ if(pingTimer){ clearInterval(pingTimer); pingTimer=null; } }
    document.addEventListener("visibilitychange", ()=>{ if (document.hidden) stopHeartbeat(); else startHeartbeat(); });
    startHeartbeat();

    function toCsvCell(v){ const s=(v??"").toString(); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }
    function visibleRowsToCsv(){
      const rows=$$("#items-body tr").filter(tr=>tr.style.display!=="none");
      const headers=["id","name","description","price_cents","category","position","confidence"];
      const out=[headers.join(",")];
      for(const tr of rows){
        const idAttr=tr.getAttribute("data-id")||"";
        const name=$(".name", tr)?.value??"";
        const desc=$(".description", tr)?.value??"";
        const priceStr=$(".price", tr)?.value??"";
        const cents=dollarsToCents(priceStr);
        const category=$(".category", tr)?.value??"";
        const position=$(".position", tr)?.value??"";
        const conf=tr.getAttribute("data-confidence")||"";
        out.push([toCsvCell(idAttr),toCsvCell(name),toCsvCell(desc),toCsvCell(String(cents)),toCsvCell(category),toCsvCell(position),toCsvCell(conf)].join(","));
      }
      return out.join("\n");
    }
    function downloadFile(filename, content, mime){ var m=mime||'text/csv;charset=utf-8'; var blob=new Blob(["\uFEFF",content],{type:m}); var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    exportVisibleBtn?.addEventListener("click", ()=>{ const csv=visibleRowsToCsv(); downloadFile('draft_{{ draft.id }}_visible.csv', csv, 'text/csv;charset=utf-8'); showToast("Exported visible rows"); });

    // Provenance tooltip
    function renderProvTip({name, cat, conf, pos}){
      const confNum = conf==="" ? null : Number(conf);
      const bucket = confNum==null ? "low" : (confNum>=80 ? "high" : (confNum>=60 ? "med":"low"));
      const prettyConf = confNum==null ? "—" : `${confNum}%`;
      provTip.innerHTML = `
        <div class="head">
          <span class="dot ${bucket}"></span>
          <strong>Provenance</strong>
        </div>
        <div class="kv">
          <span>Item</span><b>${escapeHtml(name||"")}</b>
          <span>Category</span><b>${escapeHtml(cat||"(Uncategorized)")}</b>
          <span>Confidence</span><b>${prettyConf}</b>
          <span>Position</span><b>${pos==null||pos===""?"—":escapeHtml(String(pos))}</b>
        </div>
        <div class="links">
          <a href="{{ url_for('draft_ocr_debug_json', draft_id=draft.id) }}" target="_blank" rel="noopener">OCR Debug JSON</a>
          <a href="{{ url_for('draft_ocr_debug_csv',  draft_id=draft.id) }}" target="_blank" rel="noopener">OCR Debug CSV</a>
          {% if draft.source_job_id %}
          <a href="{{ url_for('imports_ai_preview', job_id=draft.source_job_id) }}" target="_blank" rel="noopener">AI Preview</a>
          {% endif %}
        </div>
      `;
    }
    function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function wireRowProvPins(scope){
      (scope? $$(".prov-pin", scope) : $$(".prov-pin")).forEach(pin=>{
        pin.addEventListener("mouseenter", (e)=>{
          const d = {
            name: pin.dataset.provName || pin.closest("tr")?.querySelector(".name")?.value || "",
            cat:  pin.dataset.provCat  || pin.closest("tr")?.getAttribute("data-cat") || "",
            conf: pin.dataset.provConf || pin.closest("tr")?.getAttribute("data-confidence") || "",
            pos:  pin.dataset.provPos  || pin.closest("tr")?.querySelector(".position")?.value || ""
          };
          renderProvTip(d);
          provTip.style.display = "block";
          positionProvTip(e);
        });
        pin.addEventListener("mousemove", positionProvTip);
        pin.addEventListener("mouseleave", ()=>{ provTip.style.display = "none"; });
      });
    }
    function positionProvTip(evt){
      const pad = 12;
      let x = evt.clientX + pad, y = evt.clientY + pad;
      const r = provTip.getBoundingClientRect();
      if (x + r.width > window.innerWidth - 10) x = evt.clientX - r.width - pad;
      if (y + r.height > window.innerHeight - 10) y = evt.clientY - r.height - pad;
      provTip.style.left = x + "px";
      provTip.style.top  = y + "px";
    }

    wireRowProvPins();
    applyConfidenceTint();
    rebuildOutline();
    collectRowsFiltered();

    // ---- Live status pill for Finalize with AI ----
    (function(){
      const form = document.getElementById('finalize-ai-form');
      const pill = document.getElementById('finalize-status');
      if (!form || !pill) return;

      const PILL_CLASSES = {
        idle:     'pill-gray',
        working:  'pill-blue',
        done:     'pill-green',
        failed:   'pill-red'
      };

      function setPill(state, text) {
        pill.className = 'pill ' + (PILL_CLASSES[state] || 'pill-gray');
        pill.textContent = text;
        pill.style.display = 'inline-block';
      }

      form.addEventListener('submit', () => {
        setPill('working', 'Running…');
        if (window.showProgressBar) showProgressBar(45000, 'Finalizing with AI cleanup…');
        // optimistic visual update before redirect lands back here
        setTimeout(() => setPill('done', 'Refreshing…'), 20000);
      });
    })();

  })();
  </script>
</div>
{% endblock %}
