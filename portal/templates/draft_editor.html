{% extends "base.html" %}
{% block title %}Draft Editor · Draft #{{ draft.id }}{% endblock %}

{% block content %}
<style>
  /* --- Darker editor container (scoped to this page only) --- */
  .draft-editor {
    background:#0e1729;              /* darker navy */
    color:#e8eefc;                   /* light ink for labels/meta */
    border:1px solid #1f2a44;
    border-radius:14px;
    padding:18px;
    box-shadow:0 10px 28px rgba(0,0,0,.35);
  }

  /* Keep inputs HIGH-contrast: white bg + black lettering */
  .draft-editor .cell-input,
  .draft-editor .cell-textarea,
  .draft-editor .cell-select,
  .draft-editor .cell-number,
  .draft-editor .title-input,
  .draft-editor input[type="text"],
  .draft-editor textarea {
    background:#fff !important;
    color:#000 !important;
    border:1px solid #d1d5db;
    border-radius:8px;
  }

  /* Page header + meta */
  .page-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
  .meta { display:flex; gap:18px; color:#9fb0d1; font-size:0.95rem; margin-bottom:10px; flex-wrap:wrap; }
  .status-pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
  .status-editing  { background:#e0f2fe; color:#075985; }
  .status-submitted{ background:#fef3c7; color:#92400e; }
  .status-approved { background:#dcfce7; color:#065f46; }
  .status-rejected { background:#fee2e2; color:#991b1b; }
  .status-archived { background:#e5e7eb; color:#374151; }

  .toolbar { display:flex; align-items:center; gap:8px; margin:12px 0; flex-wrap:wrap; }
  .toolbar .spacer { flex:1; }

  /* Table on dark background */
  .table-wrap { overflow:auto; border:1px solid #1f2a44; border-radius:10px; }
  table.editor { width:100%; border-collapse:separate; border-spacing:0; }
  table.editor thead th {
    position:sticky; top:0;
    background:#0b1220;
    color:#e8eefc;
    font-weight:700; padding:10px;
    border-bottom:1px solid #24304d; text-align:left;
  }
  table.editor tbody td { padding:8px; border-bottom:1px solid #18233c; vertical-align:top; }
  table.editor tbody tr:nth-child(odd)  { background:#0f1a2e; }
  table.editor tbody tr:nth-child(even) { background:#0b1527; }

  .cell-textarea { min-height:36px; resize:vertical; }
  .cell-price { width:120px; }
  .cell-pos { width:90px; }
  .row-actions { display:flex; gap:6px; }

  /* Buttons – keep your scheme (primary blue, danger red) */
  .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:#111827; text-decoration:none; cursor:pointer; }
  .btn:hover { background:#f3f4f6; }
  .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
  .btn-primary:hover { background:#1d4ed8; }
  .btn-secondary { background:#111827; color:#fff; border-color:#111827; }
  .btn-danger { background:#ef4444; color:#fff; border-color:#ef4444; }
  .btn-ghost { background:#fff; color:#111827; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }

  .badge { padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.8rem; }
  .muted { color:#9fb0d1; }
  .dirty-dot { width:8px; height:8px; border-radius:50%; background:#f59e0b; display:inline-block; margin-left:6px; vertical-align:middle; }

  .note { margin-top:8px; font-size:0.9rem; color:#9fb0d1; }
  .toast { position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:12px 14px; border-radius:10px; box-shadow:0 10px 26px rgba(0,0,0,.25); display:none; z-index:1000; }
  .error-banner { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:10px 12px; border-radius:10px; margin:10px 0; display:none; }
  .success-banner { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; padding:10px 12px; border-radius:10px; margin:10px 0; display:none; }

  .title-input { font-size:1.15rem; font-weight:700; border:none; outline:none; background:#fff; border-bottom:2px solid transparent; padding:4px 6px; border-radius:6px; }
  .title-input:focus { border-color:#d1d5db; }
  .search { min-width:240px; }
</style>

<div class="draft-editor">
  <div class="page-header">
    <div>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input id="draft-title" class="title-input" value="{{ draft.title|e }}" {% if draft.status != 'editing' %}disabled{% endif %} />
        {% set s = draft.status %}
        <span class="status-pill status-{{ s }}">{{ s }}</span>
        <span id="dirty-indicator" class="badge" style="display:none;">Unsaved changes</span>
      </div>
      <div class="meta">
        <div>Draft #{{ draft.id }}</div>
        <div>Restaurant ID #{{ draft.restaurant_id }}</div>
        {% if draft.source %}<div>Source: <span class="badge">{{ draft.source }}</span></div>{% endif %}
        <div>Last saved: <span id="last-saved">{{ draft.updated_at }}</span></div>
      </div>
    </div>
    <div style="display:flex; gap:8px;">
      <a class="btn btn-ghost" href="{{ url_for('drafts_list') }}">Back to Drafts</a>
      <button id="save-btn" class="btn btn-primary" {% if draft.status != 'editing' %}disabled{% endif %}>Save Draft</button>
      <form id="submit-form" action="{{ url_for('draft_submit', draft_id=draft.id) }}" method="post" style="display:inline;">
        <button id="submit-btn" class="btn btn-secondary" {% if draft.status != 'editing' %}disabled{% endif %}>Submit for Review</button>
      </form>
    </div>
  </div>

  <div id="error-banner" class="error-banner"></div>
  <div id="success-banner" class="success-banner"></div>

  <div class="toolbar">
    <input id="search" class="cell-input search" placeholder="Search items…" />
    <div class="spacer"></div>
    <button id="add-row-btn" class="btn">Add Item</button>
    <button id="delete-selected-btn" class="btn btn-danger">Delete Selected</button>
  </div>

  <div class="table-wrap">
    <table class="editor" id="items-table">
      <thead>
        <tr>
          <th style="width:38px;"><input type="checkbox" id="select-all" /></th>
          <th style="min-width:200px;">Name <span class="muted">(required)</span></th>
          <th style="min-width:260px;">Description</th>
          <th style="min-width:120px;">Price</th>
          <th style="min-width:160px;">Category</th>
          <th style="min-width:90px;">Position</th>
          <th style="width:120px;">Actions</th>
        </tr>
      </thead>
      <tbody id="items-body">
        {% for it in items %}
        <tr data-id="{{ it.id }}">
          <td><input type="checkbox" class="row-select" /></td>
          <td><input class="cell-input name" value="{{ it.name|e }}" {% if draft.status != 'editing' %}disabled{% endif %} /></td>
          <td><textarea class="cell-textarea description" {% if draft.status != 'editing' %}disabled{% endif %}>{{ (it.description or '')|e }}</textarea></td>
          <td><input class="cell-input cell-price price" value="{{ '%.2f' % ((it.price_cents or 0)/100) }}" inputmode="decimal" {% if draft.status != 'editing' %}disabled{% endif %} /></td>
          <td>
            <input list="category-datalist" class="cell-input category" value="{{ (it.category or '')|e }}" {% if draft.status != 'editing' %}disabled{% endif %} />
          </td>
          <td><input class="cell-input cell-number position" value="{{ it.position if it.position is not none else '' }}" inputmode="numeric" {% if draft.status != 'editing' %}disabled{% endif %} /></td>
          <td class="row-actions">
            <button class="btn duplicate-btn" {% if draft.status != 'editing' %}disabled{% endif %}>Duplicate</button>
            <button class="btn btn-danger delete-btn" {% if draft.status != 'editing' %}disabled{% endif %}>Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <datalist id="category-datalist">
    {% for c in categories %}
    <option value="{{ c|e }}"></option>
    {% endfor %}
  </datalist>

  <p class="note">Shortcuts: <strong>Ctrl/Cmd+S</strong> Save · <strong>Ctrl/Cmd+Enter</strong> Submit · <strong>Delete</strong> Delete selected.</p>

  <div id="toast" class="toast"></div>
</div>

<!-- Single source of truth for server data (pure JSON, no JS parsing confusion) -->
<script id="draft-meta" type="application/json">
{{ {"id": draft.id, "status": draft.status}|tojson }}
</script>

<script>
(function() {
  // Read and parse the JSON emitted above
  const metaEl = document.getElementById('draft-meta');
  const meta = metaEl ? JSON.parse(metaEl.textContent || '{}') : {};
  const draftId = Number(meta.id);
  const draftStatus = String(meta.status || '');
  const isEditable = draftStatus === 'editing';

  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const itemsBody = $("#items-body");
  const saveBtn = $("#save-btn");
  const submitBtn = $("#submit-btn");
  const submitForm = $("#submit-form");
  const titleInput = $("#draft-title");
  const dirtyIndicator = $("#dirty-indicator");
  const errorBanner = $("#error-banner");
  const successBanner = $("#success-banner");
  const toast = $("#toast");
  const selectAll = $("#select-all");
  const search = $("#search");

  let dirty = false;

  function setDirty(v) {
    dirty = !!v;
    dirtyIndicator.style.display = dirty ? "inline-block" : "none";
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 1800);
  }

  function showError(msg) {
    errorBanner.textContent = msg;
    errorBanner.style.display = "block";
    successBanner.style.display = "none";
  }
  function showSuccess(msg) {
    successBanner.textContent = msg;
    successBanner.style.display = "block";
    errorBanner.style.display = "none";
    setTimeout(() => { successBanner.style.display = "none"; }, 2200);
  }

  function dollarsToCents(val) {
    if (val === null || val === undefined) return 0;
    let s = String(val).trim().replace(/[$,]/g, "");
    if (s === "") return 0;
    const n = Number(s);
    if (Number.isNaN(n)) return 0;
    return Math.round(n * 100);
  }

  function collectRowsFiltered() {
    const q = search.value.trim().toLowerCase();
    const rows = $$("#items-body tr");
    rows.forEach(tr => {
      const name = $(".name", tr)?.value?.toLowerCase() || "";
      const desc = $(".description", tr)?.value?.toLowerCase() || "";
      const cat  = $(".category", tr)?.value?.toLowerCase() || "";
      const match = !q || name.includes(q) || desc.includes(q) || cat.includes(q);
      tr.style.display = match ? "" : "none";
    });
  }

  function collectPayload() {
    const items = [];
    let errors = [];

    $$("#items-body tr").forEach(tr => {
      if (tr.style.display === "none") return;
      const idAttr = tr.getAttribute("data-id");
      const id = idAttr && /^\d+$/.test(idAttr) ? Number(idAttr) : (idAttr || null);

      const name = $(".name", tr).value.trim();
      const description = $(".description", tr).value.trim();
      const priceStr = $(".price", tr).value.trim();
      const category = $(".category", tr).value.trim();
      const positionStr = $(".position", tr).value.trim();

      if (!name) {
        errors.push("Name is required for all items.");
        tr.classList.add("row-error");
      } else {
        tr.classList.remove("row-error");
      }

      const price_cents = dollarsToCents(priceStr);
      if (price_cents < 0) {
        errors.push("Price cannot be negative.");
      }

      let position = null;
      if (positionStr !== "") {
        const p = Number(positionStr);
        if (Number.isNaN(p) || !Number.isInteger(p)) {
          errors.push("Position must be an integer.");
        } else {
          position = p;
        }
      }

      items.push({
        id,
        name,
        description,
        price_cents,
        category: category || null,
        position
      });
    });

    const title = titleInput.value.trim();

    return { title, items, errors };
  }

  async function saveNow() {
    if (!isEditable) return;
    const { title, items, errors } = collectPayload();
    if (errors.length) {
      showError(errors[0]);
      return;
    }
    try {
      const res = await fetch(`/drafts/${draftId}/save`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, items, deleted_item_ids: deletedIds })
      });
      const data = await res.json();
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || "Save failed");
      }

      let insIdx = 0;
      $$("#items-body tr").forEach(tr => {
        const idAttr = tr.getAttribute("data-id");
        if (!idAttr || !/^\d+$/.test(idAttr)) {
          const newId = data.inserted_ids?.[insIdx++];
          if (newId) tr.setAttribute("data-id", String(newId));
        }
      });

      $("#last-saved").textContent = data.saved_at || new Date().toISOString();
      setDirty(false);
      showSuccess("Saved");
    } catch (e) {
      showError(String(e));
    } finally {
      deletedIds = [];
    }
  }

  function submitIfValid(e) {
    const { errors } = collectPayload();
    if (errors.length) {
      e?.preventDefault?.();
      showError("Fix validation issues before submitting.");
      return false;
    }
    return true;
  }

  // Event wiring
  if (isEditable) {
    itemsBody.addEventListener("input", () => setDirty(true));
    titleInput.addEventListener("input", () => setDirty(true));
    saveBtn.addEventListener("click", (e) => { e.preventDefault(); saveNow(); });

    document.addEventListener("keydown", (e) => {
      const mod = e.metaKey || e.ctrlKey;
      if (mod && e.key === "s") {
        e.preventDefault();
        saveNow();
      } else if (mod && e.key === "Enter") {
        e.preventDefault();
        if (submitIfValid(e)) submitForm.submit();
      } else if (e.key === "Delete") {
        e.preventDefault();
        deleteSelected();
      }
    });
  }

  // Search filter
  search.addEventListener("input", collectRowsFiltered);

  // Row ops
  let rowSeq = 1;
  function newTempId() { return "tmp-" + (rowSeq++); }

  function addRow(prefill={}) {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", newTempId());
    tr.innerHTML = `
      <td><input type="checkbox" class="row-select" /></td>
      <td><input class="cell-input name" value="${(prefill.name||"").replace(/"/g, '&quot;')}" /></td>
      <td><textarea class="cell-textarea description">${(prefill.description||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea></td>
      <td><input class="cell-input cell-price price" value="${prefill.price_cents!=null? (prefill.price_cents/100).toFixed(2): ''}" inputmode="decimal" /></td>
      <td><input list="category-datalist" class="cell-input category" value="${(prefill.category||"").replace(/"/g, '&quot;')}" /></td>
      <td><input class="cell-input cell-number position" value="${prefill.position!=null? prefill.position : ''}" inputmode="numeric" /></td>
      <td class="row-actions">
        <button class="btn duplicate-btn">Duplicate</button>
        <button class="btn btn-danger delete-btn">Delete</button>
      </td>
    `;
    itemsBody.prepend(tr);
    setDirty(true);
    return tr;
  }

  $("#add-row-btn").addEventListener("click", (e) => {
    e.preventDefault();
    const tr = addRow({ position: 0 });
    const nameInput = $(".name", tr);
    if (nameInput) nameInput.focus();
  });

  // duplicate / delete buttons
  itemsBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const tr = e.target.closest("tr");
    if (!tr) return;

    if (btn.classList.contains("duplicate-btn")) {
      const clone = tr.cloneNode(true);
      clone.setAttribute("data-id", newTempId());
      const nameEl = $(".name", clone);
      if (nameEl) nameEl.value = (nameEl.value || "") + " (copy)";
      itemsBody.insertBefore(clone, tr.nextSibling);
      setDirty(true);
      showToast("Duplicated");
    } else if (btn.classList.contains("delete-btn")) {
      queueDelete(tr);
      tr.remove();
      setDirty(true);
      showToast("Deleted");
    }
  });

  // select all + bulk delete
  const selectAllEl = selectAll;
  if (selectAllEl) {
    selectAllEl.addEventListener("change", () => {
      const checked = selectAllEl.checked;
      $$(".row-select").forEach(cb => cb.checked = checked);
    });
  }

  $("#delete-selected-btn").addEventListener("click", (e) => {
    e.preventDefault();
    const selected = $$(".row-select").filter(cb => cb.checked).map(cb => cb.closest("tr"));
    if (!selected.length) return;
    selected.forEach(tr => { queueDelete(tr); tr.remove(); });
    setDirty(true);
    showToast(`Deleted ${selected.length} item(s)`);
  });

  // Delete tracking (server-side queue)
  let deletedIds = [];
  function queueDelete(tr) {
    const idAttr = tr.getAttribute("data-id");
    if (idAttr && /^\d+$/.test(idAttr)) {
      deletedIds.push(Number(idAttr));
    }
  }

  // Validate before submit
  submitForm.addEventListener("submit", (e) => {
    if (!submitIfValid(e)) return;
    if (dirty) {
      e.preventDefault();
      saveNow().then(() => submitForm.submit()).catch(() => {});
    }
  });

  // Price auto-format on blur
  itemsBody.addEventListener("blur", (e) => {
    const el = e.target;
    if (el && el.classList.contains("price")) {
      const cents = dollarsToCents(el.value);
      el.value = (cents/100).toFixed(2);
    }
  }, true);

  // Warn on navigation with unsaved changes
  window.addEventListener("beforeunload", (e) => {
    if (dirty && isEditable) {
      e.preventDefault();
      e.returnValue = "";
    }
  });

})();
</script>
{% endblock %}
