{% extends "base.html" %}
{% block title %}Import a Menu · ServLine{% endblock %}

{% block content %}
  <section class="card max-w-3xl mx-auto">
    <h1 class="text-xl font-semibold mb-2">Import a Menu</h1>
    <p class="muted mb-4">
      Upload a photo, PDF, or structured CSV/XLSX/JSON. We’ll create a draft you can review and publish into your menus.
    </p>

    <!-- Toolbar -->
    <div class="mb-6 flex flex-wrap gap-2">
      <a class="btn btn-primary" href="{{ url_for('ocr_health_route') }}">OCR Health</a>
    </div>

    <!-- Upload panels -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Upload Image -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-2">Upload Image</h2>
        <form id="imgForm" action="#" method="post" enctype="multipart/form-data" class="space-y-2">
          <input type="file" name="file" accept="image/png,image/jpeg" required class="form-control w-full" />
          <button type="submit" class="btn btn-primary w-full" id="imgBtn">Upload Image</button>
        </form>
        <p class="muted mt-2 text-sm">PNG or JPG. Great for phone photos of printed menus.</p>
      </div>

      <!-- Upload PDF -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-2">Upload PDF</h2>
        <form id="pdfForm" action="#" method="post" enctype="multipart/form-data" class="space-y-2">
          <input type="file" name="file" accept="application/pdf" required class="form-control w-full" />
          <button type="submit" class="btn btn-primary w-full" id="pdfBtn">Upload PDF</button>
        </form>
        <p class="muted mt-2 text-sm">For digital menus. We’ll extract text and structure a draft.</p>
      </div>

      <!-- Structured CSV Import -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-2">Structured CSV (POS export)</h2>
        <form id="csvForm" action="#" method="post" enctype="multipart/form-data" class="space-y-2">
          <input type="file" name="file" accept=".csv,text/csv" required class="form-control w-full" />
          <button type="submit" class="btn btn-secondary w-full" id="csvBtn">Import CSV to Draft</button>
        </form>
        <p class="muted mt-2 text-sm">
          For POS-style CSV exports (name, price, category, etc.). We’ll create a structured draft in the Draft Editor.
        </p>
      </div>

      <!-- Structured XLSX Import -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-2">Structured Excel (XLSX)</h2>
        <form id="xlsxForm" action="{{ url_for('import_xlsx') }}" method="post" enctype="multipart/form-data" class="space-y-2">
          <input type="file" name="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required class="form-control w-full" />
          <button type="submit" class="btn btn-secondary w-full" id="xlsxBtn">Import XLSX to Draft</button>
        </form>
        <p class="muted mt-2 text-sm">
          For Excel-style exports (one row per item). We’ll create a structured draft in the Draft Editor.
        </p>
      </div>

      <!-- Structured JSON Import -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-2">Structured JSON</h2>
        <form id="jsonForm" action="{{ url_for('import_json') }}" method="post" enctype="multipart/form-data" class="space-y-2">
          <input
            type="file"
            name="file"
            accept=".json,application/json"
            required
            class="form-control w-full"
          />
          <button type="submit" class="btn btn-secondary w-full" id="jsonBtn">Import JSON to Draft</button>
        </form>
        <p class="muted mt-2 text-sm">
          For API-style JSON exports (items array or list of objects). We’ll create a structured draft in the Draft Editor.
        </p>
      </div>
    </div>

    <!-- Shared upload progress UI -->
    <style>
      .progress-wrap { display:none; margin-top:16px; background:#0f1a2f; border:1px solid #243252; border-radius:10px; padding:12px; }
      .progress-bar  { width:0%; height:10px; background:#7aa2ff; border-radius:6px; transition:width .15s linear; }
      .progress-label{ margin-top:8px; font-size:.9rem; color:#9fb0d1; }
      .progress-wrap.active { display:block; }
    </style>
    <div id="uploadProgress" class="progress-wrap">
      <div class="progress-bar" id="uploadBar"></div>
      <div class="progress-label" id="uploadLabel">Preparing upload…</div>
    </div>

    <div class="mt-4 text-xs muted">
      Max file size: 20&nbsp;MB. Allowed: PNG, JPG, PDF, CSV, XLSX, JSON.
    </div>
  </section>

  <!-- Inline upload script: uses JSON APIs to get job/draft, then redirects -->
  <script>
  (function () {
    const progressWrap = document.getElementById('uploadProgress');
    const bar = document.getElementById('uploadBar');
    const label = document.getElementById('uploadLabel');

    function setActive(on) {
      progressWrap.classList.toggle('active', !!on);
      if (!on) { bar.style.width = '0%'; label.textContent = ''; }
    }

    function disableDuringUpload(disabled) {
      document.getElementById('imgBtn')?.toggleAttribute('disabled', disabled);
      document.getElementById('pdfBtn')?.toggleAttribute('disabled', disabled);
      document.getElementById('csvBtn')?.toggleAttribute('disabled', disabled);
      // XLSX and JSON use normal form POSTs to /import/xlsx and /import/json for now (no shared progress bar hook).
    }

    function doUpload(formEl) {
      const fileInput = formEl.querySelector('input[type="file"]');
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        alert('Please choose a file first.');
        return;
      }

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);

      setActive(true);
      disableDuringUpload(true);
      bar.style.width = '0%';
      label.textContent = 'Uploading… 0%';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/menus/import', true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
          bar.style.width = pct + '%';
          label.textContent = `Uploading… ${pct}%`;
        } else {
          label.textContent = 'Uploading…';
        }
      };

      xhr.onerror = () => {
        setActive(false);
        disableDuringUpload(false);
        alert('Network error during upload.');
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          let data = {};
          try { data = JSON.parse(xhr.responseText || '{}'); } catch (_) {}
          if (xhr.status >= 200 && xhr.status < 300 && data.job_id) {
            bar.style.width = '100%';
            label.textContent = 'Processing on server…';
            window.location.href = `/imports/view/${data.job_id}`;
          } else {
            setActive(false);
            disableDuringUpload(false);
            alert(data.error || 'Upload failed.');
          }
        }
      };

      xhr.send(fd);
    }

    function doCsvUpload(formEl) {
      const fileInput = formEl.querySelector('input[type="file"]');
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        alert('Please choose a CSV file first.');
        return;
      }

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);

      setActive(true);
      disableDuringUpload(true);
      bar.style.width = '0%';
      label.textContent = 'Uploading CSV… 0%';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/drafts/import_structured', true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
          bar.style.width = pct + '%';
          label.textContent = `Uploading CSV… ${pct}%`;
        } else {
          label.textContent = 'Uploading CSV…';
        }
      };

      xhr.onerror = () => {
        setActive(false);
        disableDuringUpload(false);
        alert('Network error during CSV upload.');
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          let data = {};
          try { data = JSON.parse(xhr.responseText || '{}'); } catch (_) {}

          if (xhr.status >= 200 && xhr.status < 300 && data.ok) {
            bar.style.width = '100%';
            label.textContent = 'Creating draft…';

            const redirectUrl = data.redirect_url
              || (data.draft_id ? `/drafts/${data.draft_id}/edit` : null);

            if (redirectUrl) {
              window.location.href = redirectUrl;
            } else {
              setActive(false);
              disableDuringUpload(false);
              alert('Structured import completed but missing redirect URL.');
            }
          } else {
            setActive(false);
            disableDuringUpload(false);
            alert((data && data.error) || 'Structured import failed.');
          }
        }
      };

      xhr.send(fd);
    }

    document.getElementById('imgForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      doUpload(e.currentTarget);
    });

    document.getElementById('pdfForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      doUpload(e.currentTarget);
    });

    document.getElementById('csvForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      doCsvUpload(e.currentTarget);
    });

    // Note: xlsxForm posts directly to /import/xlsx and jsonForm posts to /import/json.
  })();
  </script>
{% endblock %}
