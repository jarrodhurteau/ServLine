{% extends "base.html" %}
{% block title %}Recycle Bin{% endblock %}
{% block content %}

<h1 class="mb-3">Recycle Bin</h1>

<div class="mb-3 flex flex-wrap gap-2">
  {# Removed duplicates to top nav: Back to Uploads, Imports #}
  <form method="post" action="{{ url_for('artifacts_sweep') }}" style="display:inline;">
    <button type="submit" class="btn btn-primary">Artifact Sweep</button>
  </form>

  <span class="muted ml-auto">
    {{ trashed|length }} item{{ '' if trashed|length == 1 else 's' }} in bin
  </span>
</div>

{% if trashed|length == 0 %}
  <p>Recycle Bin is empty.</p>
{% else %}
  <!-- Restore selected -->
  <form method="post" action="{{ url_for('uploads_restore') }}" class="mb-4">
    <button type="submit" class="btn btn-primary">Restore Selected</button>
    <table class="table mt-2">
      <thead>
        <tr>
          <th style="width:44px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
          <th>Filename</th>
          <th>Trash Path</th>
          <th>Size</th>
          <th>Trashed At</th>
        </tr>
      </thead>
      <tbody>
        {% for t in trashed %}
        <tr>
          <td><input type="checkbox" name="trash_paths" value="{{ t.trash_path }}"></td>
          <td><code>{{ t.name or '—' }}</code></td>
          <td><code>{{ t.trash_path or '—' }}</code></td>
          <td>
            {% if t.size is defined %}
              {{ ((t.size or 0) / 1024)|round(1) }} KB
            {% else %}
              —
            {% endif %}
          </td>
          <td>{{ t.modified_iso or t.modified or '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <!-- Batch maintenance actions -->
  <div class="mb-2 flex flex-wrap gap-2">
    <form method="post" action="{{ url_for('uploads_clean_raw') }}" style="display:inline"
          onsubmit="return confirm('Move ALL raw artifacts (storage/drafts/raw and storage/raw) into the Recycle Bin?');">
      <button type="submit" class="btn btn-secondary">Clean Raw Artifacts → Bin</button>
    </form>

    <form method="post" action="{{ url_for('uploads_clean_drafts') }}" style="display:inline;"
          onsubmit="return confirm('Move ALL draft JSONs (storage/drafts) into the Recycle Bin?');">
      <button type="submit" class="btn btn-secondary">Clean Draft JSONs → Bin</button>
    </form>

    <form method="post" action="{{ url_for('uploads_empty_trash') }}" style="display:inline; margin-left:auto;"
          onsubmit="return confirm('Empty Recycle Bin permanently?');">
      <button type="submit" class="btn btn-danger">Empty Recycle Bin</button>
    </form>
  </div>
{% endif %}

<script>
function toggleAll(box){
  const checks = document.querySelectorAll('input[name="trash_paths"]');
  checks.forEach(c => c.checked = box.checked);
}
</script>
{% endblock %}
